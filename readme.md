# 打答 - 需求文档

## 项目概述

一个基于 Firebase 实时数据库的四人计分游戏应用，支持创建房间、加入房间、多场次计分、输赢计算等功能。

### 使用场景说明

- 该游戏通常只有一个计分人操作
- 不需要考虑多人同时修改数据的场景
- 采用"信任所有用户"的设计（Firebase 权限允许知道房间号的任何人读写）

## 技术方案

### 技术栈

- **前端框架**：原生 HTML/CSS/JavaScript
- **文件结构**：单文件 HTML（内嵌 CSS/JS）
- **UI 框架**：Tailwind CSS（通过 CDN 引入）
- **后端**：Firebase 实时数据库
- **设计风格**：简约现代

### 代码架构

项目采用模块化架构设计（MVC 变体），包含以下核心模块：

1.  **Config**: 应用配置与常量（Firebase 配置、游戏规则常量）
2.  **Utils**: 通用工具函数（时间格式化、输入解析）
3.  **State**: 应用状态管理（当前视图、房间数据、展开状态）
4.  **Logic**: 纯业务逻辑（分数计算、胜负判定、规则校验）
5.  **Service**: 数据服务（Firebase 交互、LocalStorage 缓存）
6.  **View**: 视图渲染组件（UI 渲染、模态框管理、DOM 操作）
7.  **Controller (App)**: 交互逻辑与流程控制（事件处理、业务流程串联）

### Firebase 配置

```javascript
const firebaseConfig = {
  apiKey: "AIzaSyAE2JJQ2w_fLcwl0tlF9qcwRCNes9oICsY",
  authDomain: "calculator-f4869.firebaseapp.com",
  databaseURL: "https://calculator-f4869-default-rtdb.firebaseio.com",
  projectId: "calculator-f4869",
  storageBucket: "calculator-f4869.firebasestorage.app",
  messagingSenderId: "657645216794",
  appId: "1:657645216794:web:1e2092b1fce925b6b09da3",
  measurementId: "G-TM8246NSRV"
};
```

## 数据结构设计

```json
rooms/
  {roomId}/
    players: [玩家A, 玩家B, 玩家C, 玩家D]
    unitScore: 0.3
    sessions: [
      {
        id: 1,
        rounds: [
          {
            roundIndex: 0,
            scores: [2, 3, 0, 4],  // A, B, C, D
            timestamp: 1678900000000
          }
        ]
      }
    ]
    currentSessionId: 1,  // 当前编辑中的场次
    lastScoreTime: 1678900000000,
    createdAt: 1678800000000
```

## 页面流程与功能

### 1. 主页

- 页面内容垂直居中
- 顶部居中显示软件名称："打答"
- 顶部右侧显示菜单按钮（图标），包含以下功能：
  - **查看现有房间**：显示所有已存在的房间号及玩家信息
  - **清理房间**：输入管理员密码 "clean" 后，显示房间列表，点击对应"删除"按钮并确认后删除数据
  - **使用方法**：查看详细的软件使用说明
  - **关于**：查看软件作者及版本信息（内容左对齐显示）
- 中间布局两个按钮，上下排列：
  - "创建房间"
  - "加入房间"
- 点击按钮切换到对应页面

### 2. 创建房间页面

- 页面内容垂直居中
- 输入框：房间号（必须是数字）
- "确认"按钮
- 验证逻辑：
  - 检查房间号是否已存在
  - 如果存在，弹出模态框提示 "房间已存在"，并提供两个选项：
    - "重新创建"：关闭弹窗，停留在创建页面
    - "进入该房间"：直接进入已存在的房间
  - 如果不存在，创建新房间
- 连接时显示"正在连接..."状态提示

### 3. 加入房间页面

- 页面内容垂直居中
- 输入框：房间号（必须是数字）
- "确认"按钮
- 验证逻辑：
  - 检查房间号是否存在
  - 如果不存在，弹出模态框提示 "房间不存在，请检查房间号"
- 连接时显示"正在连接..."状态提示

### 4. 新房间设置（仅新创建的房间）

- 提示文字："请输入4个靓仔名字（以空格或逗号分隔）"
- 输入框：支持空格、英文逗号、中文逗号分隔
- "确认"按钮
- 验证：必须输入4个名字，不能为空
- 设置完成后进入房间主界面

### 5. 房间主界面

#### 顶部区域

- 中间：软件名称 "打答"
- 右侧："退出房间" 按钮
- **下拉刷新**：支持在移动端下拉页面刷新房间最新数据

#### 每分金额设置

```txt
每分金额：0.3 [修改]
```

- 默认值：0.3
- 点击 "修改" 按钮弹出窗口输入新的金额
- 验证：必须是正数，最多1位小数
- 点击确认保存

#### 表格区域完整布局（示例）

```txt
┌─────────────────────────────────────┐
│               打答      [退出房间]   │
├─────────────────────────────────────┤
│ 每分金额：0.3 [修改]                 │
├─────────────────────────────────────┤
│ 场次 | A | B | C | D |  加场       │
├──────┼──────────────────────────────┤
│ 全部 | 12 | 34 | 23 | 43 | 计算     │
├──────┼──────────────────────────────┤
│ 2    | 8- | 7- | 1- | 4- | 收起     │
│      |2-6 |3-4 |0-1 |4-0 | 修改     │
│      |0-2 |0-3 |0-0 |0-4 | 修改     │
├──────┼──────────────────────────────┤
│ 1    | 12 | 34 | 23 | 43 | 展开     │
└──────┴──────────────────────────────┘
```

#### 表格功能说明

1. **添加新场次**
    - "加场" 按钮位于表头最后一列
    - 点击后弹出确认窗口：
      ```txt
      确认开始新场次？
      开始后将无法修改之前的场次数据。
      [取消] [确认]
      ```
    - 点击"确认"：锁定上一场，创建新的一场

2. **总分行**
    - 显示4个玩家的所有场次总分
    - 右侧有 "计算" 按钮，点击进入计算页面

3. **最新场次（显示在最上面）**
    - 显示该场次的总分
    - 右侧有 "展开" / "收起" 按钮
    - 展开后显示各局明细
    - **本局行（New）**：最新一行的分数单元格支持点击操作，可进行单人记分
    - **记分按钮**：点击行末的 "记分" 按钮可进行整局（4人）记分

4. **历史场次**
    - 展开后只显示各局明细
    - 历史局明细右侧有 "修改" 按钮（仅限当前场次内的历史局，已锁定的旧场次不可修改）

#### 记分与修改逻辑

1. **整局记分**
    - 点击 "记分" 按钮
    - 输入框：请输入4个分数（以空格或逗号分隔）
    - 适用于一局结束时统一录入

2. **单人实时记分**
    - 点击玩家对应的分数单元格（仅限最新一局或新建局）
    - 输入该玩家的分数
    - **防冲突机制**：如果当前局处于"未完成状态"（即只有部分玩家有分数），其他用户尝试操作时会弹出提示 "请等待其他人记完分"，防止数据覆盖。

3. **游戏结束判定**
    - 当某位玩家的场次总分达到或超过 100 分时（配置项 `WIN_SCORE`）
    - 系统自动弹出 "本场已结束" 模态框
    - 提供两个选项：
        - **返回修改分数**：如果是误操作导致结束，可返回修改
        - **开启下一场次**：确认结束，自动开始新的一场

### 6. 计算页面

点击 "计算" 按钮后打开新页面，显示最终计算结果：

```txt
这4位靓仔的输赢情况如下
A  +12.5
B  -8.0
...

活动时长：hh小时mm分钟
[返回房间]
```

#### 计算公式

```txt
个人输赢 = (4人总分 - 个人总场次分数 × 4) × 每分金额
```

#### 活动时长计算

- **开始时间**：房间创建时间 (`createdAt`)
- **结束时间**：最后一次计分的时间 (`lastScoreTime`)
- **显示格式**：`hh小时mm分钟`

## 验证规则

### 输入验证

1. **房间号**：必须是纯数字
2. **玩家名字**：必须输入4个名字，不能为空
3. **分数**：必须是有效数字
4. **每分金额**：必须是正数

### 功能限制

- 房间内不能重新输入4个名字
- 点击 "加场" 并确认后，上一场立即锁定，不可再修改
- 历史场次只能查看，不能修改
- 为了防止并发冲突，未完成的局（Partial Round）会限制多人同时操作

## Firebase 权限规则

```json
{
  "rules": {
    "rooms": {
      // 允许读取整个 rooms 列表（用于"查看现有房间"功能）
      ".read": true,
      "$roomId": {
        // 允许写入特定房间（创建/更新/删除）
        ".write": true
      }
    }
  }
}
```

**安全说明**：
- 采用"信任所有用户"的设计
- 只要知道房间号，任何人都可以写入（修改/删除）该房间的内容
- 适用于朋友间信任使用的场景
