# 打答 - 需求文档

## 项目概述

一个基于 Firebase 实时数据库的四人计分游戏应用，支持创建房间、加入房间、多场次计分、输赢计算等功能。

### 使用场景说明

- 该游戏通常只有一个计分人操作
- 不需要考虑多人同时修改数据的场景
- 采用"信任所有用户"的设计（Firebase 权限允许知道房间号的任何人读写）

## 技术方案

### 技术栈

- **前端框架**：原生 HTML/CSS/JavaScript
- **文件结构**：单文件 HTML（内嵌 CSS/JS）
- **UI 框架**：Tailwind CSS（通过 CDN 引入）
- **后端**：Firebase 实时数据库
- **设计风格**：简约现代

### Firebase 配置

```javascript
const firebaseConfig = {
  apiKey: "AIzaSyAE2JJQ2w_fLcwl0tlF9qcwRCNes9oICsY",
  authDomain: "calculator-f4869.firebaseapp.com",
  databaseURL: "https://calculator-f4869-default-rtdb.firebaseio.com",
  projectId: "calculator-f4869",
  storageBucket: "calculator-f4869.firebasestorage.app",
  messagingSenderId: "657645216794",
  appId: "1:657645216794:web:1e2092b1fce925b6b09da3",
  measurementId: "G-TM8246NSRV"
};
```

## 数据结构设计

```json
rooms/
  {roomId}/
    players: [玩家A, 玩家B, 玩家C, 玩家D]
    unitScore: 0.3
    sessions: [
      {
        id: 1,
        rounds: [
          {
            roundIndex: 0,
            scores: [2, 3, 0, 4]  // A, B, C, D
          }
        ]
      }
    ]
    currentSessionId: 1  // 当前编辑中的场次
```

## 页面流程与功能

### 1. 主页

- 页面内容垂直居中
- 顶部居中显示软件名称："打答"
- 顶部右侧显示菜单按钮（图标），包含以下功能：
  - **查看现有房间**：显示所有已存在的房间号及玩家信息
  - **清理房间**：输入管理员密码 "clean" 后，显示房间列表，点击对应"删除"按钮并确认后删除数据
  - **使用方法**：查看详细的软件使用说明
  - **关于**：查看软件作者及版本信息（内容左对齐显示）
- 中间布局两个按钮，上下排列：
  - "创建房间"
  - "加入房间"
- 点击按钮切换到对应页面

### 2. 创建房间页面

- 页面内容垂直居中
- 输入框：房间号（必须是数字）
- "确认"按钮
- 验证逻辑：
  - 检查房间号是否已存在
  - 如果存在，弹出模态框提示 "房间已存在"，并提供两个选项：
    - "重新创建"：关闭弹窗，停留在创建页面
    - "进入该房间"：直接进入已存在的房间
  - 如果不存在，创建新房间
- 连接时显示"正在连接..."状态提示

### 3. 加入房间页面

- 页面内容垂直居中
- 输入框：房间号（必须是数字）
- "确认"按钮
- 验证逻辑：
  - 检查房间号是否存在
  - 如果不存在，弹出模态框提示 "房间不存在，请检查房间号"
- 连接时显示"正在连接..."状态提示

### 4. 新房间设置（仅新创建的房间）

- 提示文字："请输入4个靓仔名字（以空格或逗号分隔）"
- 输入框：支持空格、英文逗号、中文逗号分隔
- "确认"按钮
- 验证：必须输入4个名字，不能为空
- 设置完成后进入房间主界面

### 5. 房间主界面

#### 顶部区域

- 中间：软件名称 "打答"
- 右侧："退出房间" 按钮

#### 每分金额设置

```txt
每分金额：0.3 [修改]
```

- 默认值：0.3
- 点击 "修改" 按钮弹出窗口输入新的金额
- 验证：必须是正数，最多1位小数
- 点击确认保存

#### 表格区域完整布局（示例）

```txt
┌─────────────────────────────────────┐
│               打答      [退出房间]   │
├─────────────────────────────────────┤
│ 每分金额：0.3 [修改]                 │
├─────────────────────────────────────┤
│ 场次 | A | B | C | D |  添加场次   │
├──────┼──────────────────────────────┤
│ 全部 | 12 | 34 | 23 | 43 | 计算结果  │
├──────┼──────────────────────────────┤
│ 2    | 8- | 7- | 1- | 4- | 收起     │
│      |2-6 |3-4 |0-1 |4-0 | 修改     │
│      |0-2 |0-3 |0-0 |0-4 | 修改     │
├──────┼──────────────────────────────┤
│ 1    | 12 | 34 | 23 | 43 | 展开     │
└──────┴──────────────────────────────┘
```

#### 表格功能说明

1. **添加新场次**
    - "添加场次" 按钮（绿色）位于表头场次列旁边
    - 点击后弹出确认窗口：

      ```txt
      确认开始新的一场游戏吗？
      开始后将无法修改之前的场次数据。
      [取消] [确认]
      ```

    - 点击"取消"：关闭窗口，不做任何操作
    - 点击"确认"：锁定上一场，创建新的一场
    - 一旦添加新场次，上一场立即锁定，不可再修改

2. **总分行**
    - 显示4个玩家的所有场次总分
    - 右侧有 "计算结果" 按钮，点击进入计算页面

3. **最新场次（显示在最上面）**
    - 显示该场次的总分
    - 右侧有 "展开" / "收起" 按钮
    - 展开后显示各局明细，每行右侧有 "修改" 按钮
    - 展开后不显示最后一列（当前显示总分和按钮的列）

4. **历史场次**
    - 显示该场次的总分
    - 右侧有 "展开" / "收起" 按钮
    - 展开后只显示各局明细，不包含 "修改" 按钮和最后一列
    - 历史场次不能修改

#### 各局明细格式（展开后显示）

格式：`当前累计-本局分`

示例（场次2展开后）：

```txt
┌─────────────────────────────────────┐
│ 2    | 8- | 7- | 1- | 4- | 收起     │
│      |2-6 |3-4 |0-1 |4-0 | 修改     │
│      |0-2 |0-3 |0-0 |0-4 | 修改     │
└─────────────────────────────────────┘
```

说明：

- 第一行：当前累计总分（不含最后一行，即最新局）
- 第二行：累计2分，本局6分（2-6）
- 第三行：初始状态，累计0分，本局2分（0-2）
- **排序规则**：新的局显示在上面，旧的局显示在下面
- 最新场次可修改（点击"修改"按钮）
- 历史场次展开后不显示"修改"按钮

#### 编辑/添加分数

点击 "修改" 或 "添加本局计分" 按钮后弹出输入框：

```txt
请输入4个分数（以空格或逗号分隔）
[ 2 3 0 4 ]  [确认]
```

- 支持：空格、英文逗号、中文逗号分隔
- 验证：必须是 0 或正整数
- 点击确认提交

#### 展开按钮交互

- 未展开时显示 "展开"
- 点击后展开明细，按钮变为 "收起"
- 再次点击收起明细，按钮变回 "展开"
- **展开/收起状态由每个用户独立控制，不保存到数据库**

### 6. 计算页面

点击 "计算结果" 按钮后打开新页面，显示最终计算结果：

```txt
这4位靓仔的输赢情况如下
x1, x2, x3, x4

活动时长：hh小时mm分钟
```

#### 计算公式

```txt
个人输赢 = (4人总分 - 个人总场次分数 × 4) × 每分金额
```

#### 活动时长计算

- **开始时间**：房间创建时间 (`createdAt`)
- **结束时间**：最后一次点击"确认"计分的时间 (`lastScoreTime`)
- **显示格式**：`活动时长：hh小时mm分钟`
- 如果数据不完整，显示"活动时长：未知"

#### 格式要求

- 保留1位小数
- 如果是整数，不显示小数位
- 例如：10.5, 8, -18.5, 0

## 验证规则

### 输入验证

1. **房间号**：必须是纯数字
2. **玩家名字**：
   - 必须输入4个名字
   - 不能为空
   - 支持空格、英文逗号、中文逗号分隔
3. **分数**：
   - 必须是 0 或正整数
   - 每次输入4个分数
4. **每分金额**：
   - 必须是正数
   - 最多支持1位小数位

### 功能限制

- 在房间内可以"退出房间"
- 房间内不能重新输入4个名字
- 最新场次可以修改
- 历史场次只能查看，不能修改
- 点击 "添加场次" 并确认后，上一场立即锁定，不可再修改

## 交互细节

1. **输入框**
   - 所有输入框右侧都有 "[确认]" 按钮（或在弹窗中）
   - 点击确认提交
   - 有输入提示文字

2. **状态提示**
   - 连接时显示 "正在连接..."
   - 错误提示用模态框显示

3. **表格交互**
   - 当前编辑项高亮显示
   - 使用斑马纹区分不同行
   - 按钮有明显的视觉反馈

4. **页面切换**
   - 点击按钮后平滑切换页面
   - 避免不必要的页面刷新

## UI 设计风格

- **整体风格**：简约现代
- **配色**：清爽的配色方案
- **布局**：居中对齐，留白充足
- **反馈**：操作有清晰的视觉反馈
- **字体**：易读的无衬线字体

### 移动端适配

#### 表格视图（默认）

- 完整的表格布局
- 所有列水平排列
- 适合大屏幕显示
- 移动端也可通过横向滚动查看

#### 响应式设计

- 输入框和按钮有足够的触摸区域（最小 44px）
- 数字键盘自动唤起（input type="number"）
- 避免误触，按钮之间有适当间距

## Firebase 权限规则

```json
{
  "rules": {
    "rooms": {
      // 允许读取整个 rooms 列表（用于"查看现有房间"功能）
      ".read": true,
      "$roomId": {
        // 允许写入特定房间（创建/更新/删除）
        ".write": true
      }
    }
  }
}
```

**安全说明**：

- `rooms` 节点公开可读，允许列出所有房间
- 只要知道房间号，任何人都可以写入（修改/删除）该房间的内容
- 这是"信任所有用户"的设计，不包含身份验证
- 适用于朋友间信任使用的场景
- 如需更强的安全性，建议添加用户认证模块
