<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç­” - å››äººè®¡åˆ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        .zebra-stripe:nth-child(odd) {
            background-color: #f9fafb;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .active-session {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="loadingStatus" class="fixed top-0 left-0 w-full bg-blue-500 text-white text-xs py-1 text-center hidden">
        æ­£åœ¨è¿æ¥...
    </div>

    <div id="app" class="max-w-md mx-auto p-4 pb-20">
        <div id="view-container"></div>
    </div>

    <div id="modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-xl">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">æç¤º</h3>
            <div id="modalBody" class="mb-6"></div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-500 text-white rounded">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAE2JJQ2w_fLcwl0tlF9qcwRCNes9oICsY",
            authDomain: "calculator-f4869.firebaseapp.com",
            databaseURL: "https://calculator-f4869-default-rtdb.firebaseio.com",
            projectId: "calculator-f4869",
            storageBucket: "calculator-f4869.firebasestorage.app",
            messagingSenderId: "657645216794",
            appId: "1:657645216794:web:1e2092b1fce925b6b09da3",
            measurementId: "G-TM8246NSRV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. çŠ¶æ€ç®¡ç† ---
        let state = {
            view: 'home', // home, create, join, setup, room, calculate
            roomId: null,
            roomData: null,
            expandedSessions: new Set(), // ä»…æœ¬åœ°å­˜å‚¨
            viewMode: 'table' // table, card
        };

        // --- 3. æ ¸å¿ƒå·¥å…·å‡½æ•° ---
        const showLoading = (show) => document.getElementById('loadingStatus').classList.toggle('hidden', !show);

        function navigate(view) {
            state.view = view;
            render();
        }

        function parseInput(str) {
            return str.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
        }

        // --- 4. æ•°æ®åº“äº¤äº’ ---
        async function joinRoom(id, isCreate = false) {
            if (!/^\d+$/.test(id)) return alert("æˆ¿é—´å·å¿…é¡»æ˜¯æ•°å­—");
            showLoading(true);

            const snapshot = await db.ref('rooms/' + id).once('value');
            const exists = snapshot.exists();

            if (isCreate && exists) {
                const modalContent = `
                    <div class="text-left">
                        <p class="mb-4">æˆ¿é—´å· <strong>${id}</strong> å·²å­˜åœ¨ã€‚</p>
                        <p class="mb-4 text-sm text-gray-600">æ‚¨å¯ä»¥é€‰æ‹©ï¼š</p>
                        <div class="space-y-2">
                            <button onclick="closeModal()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">é‡æ–°åˆ›å»º (è¿”å›)</button>
                            <button onclick="confirmEnterRoom('${id}')" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600">è¿›å…¥è¯¥æˆ¿é—´</button>
                        </div>
                    </div>
                `;
                showModal("æˆ¿é—´å·²å­˜åœ¨", modalContent, null);
                // Note: We don't proceed here. User must click "Enter Room" to proceed.
                return;
            } else if (!isCreate && !exists) {
                showLoading(false);
                return showModal("æç¤º", "æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æˆ¿é—´å·", closeModal);
            }

            enterRoom(id);
        }

        function confirmEnterRoom(id) {
            closeModal();
            enterRoom(id);
        }

        function enterRoom(id) {
            state.roomId = id;
            db.ref('rooms/' + id).on('value', (snap) => {
                state.roomData = snap.val();
                showLoading(false);
                if (!state.roomData || !state.roomData.players) {
                    navigate('setup');
                } else {
                    // Item 21: Default to expanded for the latest session
                    if (state.roomData.sessions && state.roomData.sessions.length > 0) {
                        const latestSessionId = state.roomData.sessions[state.roomData.sessions.length - 1].id;
                        state.expandedSessions.add(latestSessionId);
                    }
                    if (state.view !== 'calculate') navigate('room');
                }
            });
        }

        function exitRoom() {
            if (state.roomId) db.ref('rooms/' + state.roomId).off();
            state.roomId = null;
            state.roomData = null;
            navigate('home');
        }

        // --- 5. ä¸šåŠ¡é€»è¾‘ ---
        function submitSetup() {
            const names = parseInput(document.getElementById('playerNames').value);
            if (names.length !== 4) return alert("è¯·è¾“å…¥æ­£å¥½4ä¸ªé“ä»”çš„åå­—");

            db.ref('rooms/' + state.roomId).update({
                players: names,
                unitScore: 0.3,
                currentSessionId: 1,
                sessions: [{ id: 1, rounds: [] }],
                createdAt: Date.now()
            });
        }

        function openUnitScoreModal() {
            showModal("ä¿®æ”¹æ¯åˆ†é‡‘é¢", "è¯·è¾“å…¥æ¯åˆ†å¤šå°‘é’±ï¼š", () => {
                const val = parseFloat(document.getElementById('modalInput').value);
                if (isNaN(val) || val <= 0) return alert("è¯·è¾“å…¥æ­£æ•°");
                db.ref(`rooms/${state.roomId}/unitScore`).set(parseFloat(val.toFixed(1)));
                closeModal();
            }, true, state.roomData.unitScore);
        }

        function startNewSession() {
            showModal("ç¡®è®¤å¼€å§‹æ–°åœºæ¬¡ï¼Ÿ", "å¼€å§‹åå°†æ— æ³•ä¿®æ”¹ä¹‹å‰çš„åœºæ¬¡æ•°æ®ã€‚", () => {
                const sessions = state.roomData.sessions || [];
                const newId = sessions.length + 1;
                sessions.push({ id: newId, rounds: [] });
                db.ref('rooms/' + state.roomId).update({
                    sessions: sessions,
                    currentSessionId: newId
                });
                closeModal();
            });
        }

        function openScoreModal(sessionIdx, roundIdx = null) {
            const isEdit = roundIdx !== null;
            const currentRounds = state.roomData.sessions[sessionIdx].rounds || [];
            const defaultValue = isEdit ? currentRounds[roundIdx].scores.join(' ') : "";

            showModal(isEdit ? "ä¿®æ”¹åˆ†æ•°" : "æ·»åŠ è®¡åˆ†", "è¯·è¾“å…¥4ä¸ªåˆ†æ•°ï¼ˆç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼‰ï¼š", () => {
                const scores = parseInput(document.getElementById('modalInput').value).map(Number);
                if (scores.length !== 4 || scores.some(isNaN)) return alert("è¯·è¾“å…¥4ä¸ªæœ‰æ•ˆæ•°å­—");

                if (isEdit) {
                    currentRounds[roundIdx].scores = scores;
                } else {
                    currentRounds.push({ roundIndex: currentRounds.length, scores: scores });
                }

                db.ref(`rooms/${state.roomId}/sessions/${sessionIdx}/rounds`).set(currentRounds);
                // Item 23: Update last score time
                db.ref(`rooms/${state.roomId}/lastScoreTime`).set(Date.now());
                closeModal();
            }, true, defaultValue);
        }

        // --- èœå•åŠŸèƒ½ ---
        function toggleMenu() {
            state.showMenu = !state.showMenu;
            render();
        }

        async function menuViewRooms() {
            state.showMenu = false;
            render();
            showLoading(true);
            const snapshot = await db.ref('rooms').once('value');
            showLoading(false);
            const rooms = snapshot.val();

            let content = "";
            if (!rooms) {
                content = "æš‚æ— æˆ¿é—´";
            } else {
                content = Object.keys(rooms).map(id => {
                    const r = rooms[id];
                    const players = r.players ? r.players.join('ï¼Œ') : 'ï¼ˆæœªè®¾ç½®ç©å®¶ï¼‰';
                    return `<div class="mb-2 border-b pb-1"><strong>æˆ¿é—´å·ï¼š${id}</strong><br><span class="text-xs text-gray-500">${players}</span></div>`;
                }).join('');
            }
            showModal("ç°æœ‰æˆ¿é—´", content, closeModal);
        }

        function menuCleanRoom() {
            state.showMenu = false;
            render();
            showModal("æ¸…ç†æˆ¿é—´", "è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š", () => {
                const pwd = document.getElementById('modalInput').value;
                if (pwd !== 'clean') {
                    // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æ›¿ä»£ alert
                    showModal("é”™è¯¯", "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚", closeModal);
                    return;
                }
                closeModal();
                setTimeout(showCleanRoomList, 200);
            }, true);
        }

        async function showCleanRoomList() {
            showLoading(true);
            const snapshot = await db.ref('rooms').once('value');
            showLoading(false);
            const rooms = snapshot.val();

            let content = "";
            if (!rooms) {
                content = "æš‚æ— æˆ¿é—´";
            } else {
                content = Object.keys(rooms).map(id => {
                    const r = rooms[id];
                    const players = r.players ? r.players.join('ï¼Œ') : 'ï¼ˆæœªè®¾ç½®ç©å®¶ï¼‰';
                    return `
                        <div class="flex justify-between items-center mb-2 border-b pb-1">
                            <div class="flex-1">
                                <strong>æˆ¿é—´å·ï¼š${id}</strong><br>
                                <span class="text-xs text-gray-500">${players}</span>
                            </div>
                            <button onclick="confirmDeleteRoom('${id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded ml-2 shadow-sm transition-colors">åˆ é™¤</button>
                        </div>`;
                }).join('');
            }
            showModal("æ¸…ç†æˆ¿é—´åˆ—è¡¨", content, null);
        }

        function confirmDeleteRoom(roomId) {
            showModal("ç¡®è®¤åˆ é™¤", `ç¡®å®šè¦åˆ é™¤æˆ¿é—´ <span class="font-bold text-red-500">${roomId}</span> åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ<br><br><span class="text-xs text-gray-500">æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</span>`, () => {
                db.ref('rooms/' + roomId).remove()
                    .then(() => {
                        // ä½¿ç”¨ showModal æ›¿ä»£ alertï¼Œé¿å…æ˜¾ç¤º file://
                        showModal("åˆ é™¤æˆåŠŸ", "æˆ¿é—´ " + roomId + " å·²åˆ é™¤", () => {
                            closeModal();
                            setTimeout(showCleanRoomList, 200);
                        });
                    })
                    .catch(e => showModal("åˆ é™¤å¤±è´¥", "åˆ é™¤å¤±è´¥ï¼š" + e.message, closeModal));
            });
        }

        function menuUsage() {
            state.showMenu = false;
            render();
            const content = `
                <div class="text-sm space-y-3 text-left">
                    <p><strong>1. å¦‚ä½•åˆ›å»ºæˆ¿é—´ï¼š</strong>ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                    <p><strong>2. å¦‚ä½•åŠ å…¥æˆ¿é—´ï¼š</strong>ç‚¹å‡»"åŠ å…¥æˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                    <p><strong>3. å¦‚ä½•ä¿®æ”¹æ¯åˆ†é‡‘é¢ï¼š</strong>ç‚¹å‡»"æ¯åˆ†é‡‘é¢"åé¢çš„"ä¿®æ”¹"æŒ‰é’®ï¼Œè¾“å…¥æ–°çš„é‡‘é¢ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                    <p><strong>4. å¦‚ä½•æ·»åŠ åœºæ¬¡ï¼š</strong>ç‚¹å‡»è¡¨æ ¼å¤´éƒ¨çš„"æ·»åŠ åœºæ¬¡"æŒ‰é’®ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                    <p><strong>5. å¦‚ä½•æ·»åŠ æœ¬å±€è®¡åˆ†ï¼š</strong>ç‚¹å‡»æœ€æ–°å±€çš„"è®¡åˆ†"æŒ‰é’®ï¼ŒæŒ‰é¡ºåºè¾“å…¥ç©å®¶Aã€Bã€Cã€Dçš„å¾—åˆ†ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                    <p><strong>6. å¦‚ä½•è®¡ç®—ç»“æœï¼š</strong>ç‚¹å‡»"è®¡ç®—ç»“æœ"æŒ‰é’®ï¼Œå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºè®¡ç®—ç»“æœã€‚</p>
                    <p><strong>7. è®¡ç®—å…¬å¼ï¼š</strong><br>
                    ä¸ªäººè¾“èµ¢ = (4äººæ€»åˆ† - ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° Ã— 4) Ã— æ¯åˆ†é‡‘é¢<br>
                    <span class="text-xs text-gray-400">ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° = ä¸ªäººåœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                    4äººæ€»åˆ† = æ‰€æœ‰ç©å®¶åœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                    æ¯åˆ†é‡‘é¢ = ç”¨æˆ·åœ¨è½¯ä»¶ä¸­è®¾ç½®çš„æ¯åˆ†é‡‘é¢</span></p>
                </div>
            `;
            showModal("ä½¿ç”¨æ–¹æ³•", content, closeModal);
        }

        function menuAbout() {
            state.showMenu = false;
            render();
            const content = `
                <div class="text-left space-y-2">
                    <p><strong>è½¯ä»¶åç§°ï¼š</strong>æ‰“ç­”</p>
                    <p><strong>ä½œè€…ï¼š</strong>Kaishen</p>
                    <p><strong>è”ç³»ä½œè€…ï¼š</strong>å…ˆçœ‹"ä½¿ç”¨æ–¹æ³•"ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œå†è”ç³»ä½œè€…ã€‚</p>
                    <p><strong>è½¯ä»¶ç›®çš„ï¼š</strong>æä¾›ä¸€ä¸ªæ–¹ä¾¿çš„æ‰“ç­”è®°å½•å’Œè®¡åˆ†è½¯ä»¶ã€‚</p>
                    <p class="mt-4 italic text-gray-500 text-center">"èµ¢é’±éæˆ‘æ„ï¼Œä½†æ„¿å‹é•¿å­˜ã€‚"</p>
                </div>
            `;
            showModal("å…³äº", content, closeModal);
        }

        // --- 6. è§†å›¾æ¸²æŸ“ ---
        function render() {
            const container = document.getElementById('view-container');

            // åŸºç¡€å¸ƒå±€ï¼šé¦–é¡µ
            if (state.view === 'home') {
                container.innerHTML = `
                    <div class="flex flex-col min-h-[80vh]">
                        <div class="flex justify-end pt-2 relative">
                            <button onclick="toggleMenu()" class="p-2 text-gray-600 hover:text-gray-900 focus:outline-none transition-colors rounded-full hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                            </button>
                            ${state.showMenu ? `
                            <div class="absolute right-0 top-12 w-48 bg-white border border-gray-200 rounded-lg shadow-2xl z-50 text-base overflow-hidden animate-fade-in-down">
                                <button onclick="menuViewRooms()" class="block w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 hover:text-blue-600 border-b border-gray-100 transition-colors flex items-center">
                                    <span class="mr-2">ğŸ </span> æŸ¥çœ‹ç°æœ‰æˆ¿é—´
                                </button>
                                <button onclick="menuCleanRoom()" class="block w-full text-left px-4 py-3 hover:bg-red-50 text-gray-700 hover:text-red-600 border-b border-gray-100 transition-colors flex items-center">
                                    <span class="mr-2">ğŸ—‘ï¸</span> æ¸…ç†æˆ¿é—´
                                </button>
                                <button onclick="menuUsage()" class="block w-full text-left px-4 py-3 hover:bg-green-50 text-gray-700 hover:text-green-600 border-b border-gray-100 transition-colors flex items-center">
                                    <span class="mr-2">ğŸ“–</span> ä½¿ç”¨æ–¹æ³•
                                </button>
                                <button onclick="menuAbout()" class="block w-full text-left px-4 py-3 hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition-colors flex items-center">
                                    <span class="mr-2">â„¹ï¸</span> å…³äº
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex-1 flex flex-col justify-center pb-20">
                            <h1 class="text-5xl font-black text-center mb-16 tracking-widest text-blue-600 drop-shadow-sm">æ‰“ç­”</h1>
                            <div class="flex flex-col space-y-6 px-8">
                                <button onclick="navigate('create')" class="bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">â•</span> åˆ›å»ºæˆ¿é—´
                                </button>
                                <button onclick="navigate('join')" class="bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 py-5 rounded-2xl font-bold text-xl shadow-md active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">ğŸ”</span> åŠ å…¥æˆ¿é—´
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.view === 'create' || state.view === 'join') {
                const isCreate = state.view === 'create';
                container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-2xl font-bold mb-6 text-center">${isCreate ? 'åˆ›å»º' : 'åŠ å…¥'}æˆ¿é—´</h2>
                        <input type="number" id="roomNumInput" placeholder="è¾“å…¥æˆ¿é—´å·(æ•°å­—)" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 text-center text-xl focus:border-blue-500 outline-none">
                        <button onclick="joinRoom(document.getElementById('roomNumInput').value, ${isCreate})" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">ç¡®è®¤</button>
                        <button onclick="navigate('home')" class="w-full text-gray-500 mt-4 text-center">è¿”å›</button>
                    </div>
                `;
            }
            else if (state.view === 'setup') {
                container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-xl font-bold mb-4">æ–°æˆ¿é—´è®¾ç½®</h2>
                        <p class="text-gray-600 mb-2 text-sm">è¯·è¾“å…¥4ä¸ªé“ä»”åå­—ï¼ˆç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼‰</p>
                        <input type="text" id="playerNames" placeholder="å°ç‹ å°æ é˜¿å¼º å¤§å£®" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 outline-none focus:border-blue-500">
                        <button onclick="submitSetup()" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">è¿›å…¥æˆ¿é—´</button>
                    </div>
                `;
            }
            else if (state.view === 'room') {
                renderRoom(container);
            }
            else if (state.view === 'calculate') {
                renderCalculate(container);
            }
        }

        function renderRoom(container) {
            const d = state.roomData;
            const players = d.players;
            const sessions = [...d.sessions].reverse(); // æœ€æ–°åœºæ¬¡åœ¨ä¸Š

            let html = `
                <div class="relative flex justify-center items-center mb-6">
                    <h1 class="text-2xl font-black text-blue-600">æ‰“ç­”</h1>
                    <button onclick="exitRoom()" class="absolute right-0 text-red-500 font-medium text-sm border border-red-200 px-3 py-1 rounded">é€€å‡ºæˆ¿é—´</button>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold">æ¯åˆ†é‡‘é¢:</span>
                        <span class="font-bold text-lg mx-2">${d.unitScore}</span>
                        <button onclick="openUnitScoreModal()" class="text-blue-500 text-sm font-bold">ä¿®æ”¹</button>
                    </div>
                </div>
            `;

            // Table View Only
            html += `
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 text-center text-sm">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-800 text-white">
                            <th class="py-3 px-1 font-medium">åœºæ¬¡</th>
                            ${players.map(p => `<th class="py-3 px-1 font-medium">${p}</th>`).join('')}
                            <th class="py-3 px-1">
                                <button onclick="startNewSession()" class="bg-green-500 text-white text-xs px-2 py-1 rounded shadow">æ·»åŠ åœºæ¬¡</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-blue-50 font-bold border-b-2 border-blue-100">
                            <td class="py-4">å…¨éƒ¨</td>
                            ${players.map((_, i) => `<td>${calculateTotal(i)}</td>`).join('')}
                            <td class="text-blue-600 cursor-pointer font-bold" onclick="navigate('calculate')">è®¡ç®—ç»“æœ</td>
                        </tr>
                        ${sessions.map(s => renderSessionRow(s, d.players, d.currentSessionId)).join('')}
                    </tbody>
                </table>
            </div>`;

            container.innerHTML = html;
        }

        function renderSessionRow(session, players, currentId) {
            const isCurrent = session.id === currentId;
            const isExpanded = state.expandedSessions.has(session.id);
            const sessionIdx = state.roomData.sessions.findIndex(s => s.id === session.id);

            let rows = `
                <tr class="zebra-stripe ${isCurrent ? 'active-session' : ''}">
                    <td class="py-4 font-bold">${session.id}</td>
                    ${players.map((_, i) => `<td>${calculateSessionTotal(session, i)}</td>`).join('')}
                    <td class="text-blue-500 font-medium">
                        <button onclick="toggleSession(${session.id})" class="font-bold">${isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}</button>
                    </td>
                </tr>
            `;

            if (isExpanded) {
                const rounds = session.rounds || [];
                // é¡¶éƒ¨ï¼šå¦‚æœæ˜¯å½“å‰åœºæ¬¡ï¼Œæ˜¾ç¤º "æœ¬å±€" è¡Œ
                if (isCurrent) {
                    rows += `<tr class="text-[11px] text-gray-500 bg-white font-bold">
                        <td class="py-2">æœ¬å±€</td>
                        ${players.map((_, i) => `<td>${calculateSessionTotal(session, i)}-</td>`).join('')}
                        <td><button class="text-xs text-blue-500 font-bold" onclick="openScoreModal(${sessionIdx})">è®¡åˆ†</button></td>
                    </tr>`;
                }

                // å±€æ˜ç»†ï¼šå½“å‰ç´¯è®¡-æœ¬å±€åˆ†
                // è®¡ç®—æ¯å±€ä¹‹å‰çš„ç´¯è®¡åˆ†æ•°
                const roundsWithTotals = [];
                const currentTotals = [0, 0, 0, 0];
                rounds.forEach((r, rIdx) => {
                    const before = [...currentTotals];
                    r.scores.forEach((s, i) => currentTotals[i] += s);
                    roundsWithTotals.push({
                        roundIndex: rIdx,
                        scores: r.scores,
                        totalsBefore: before
                    });
                });

                // å€’åºæ˜¾ç¤º (æœ€æ–°çš„åœ¨ä¸Šé¢)
                roundsWithTotals.reverse().forEach((rData) => {
                    rows += `<tr class="text-[11px] text-gray-500 bg-white">
                        <td class="py-2">å±€ ${rData.roundIndex + 1}</td>
                        ${rData.scores.map((s, pi) => {
                        return `<td>${rData.totalsBefore[pi]}-${s}</td>`;
                    }).join('')}
                        <td>${isCurrent ? `<button class="text-xs text-blue-400 font-bold" onclick="openScoreModal(${sessionIdx}, ${rData.roundIndex})">ä¿®æ”¹</button>` : ''}</td>
                    </tr>`;
                });
            }
            return rows;
        }

        function toggleSession(id) {
            if (state.expandedSessions.has(id)) state.expandedSessions.delete(id);
            else state.expandedSessions.add(id);
            render();
        }

        function calculateSessionTotal(session, playerIdx) {
            if (!session.rounds) return 0;
            return session.rounds.reduce((sum, r) => sum + (r.scores[playerIdx] || 0), 0);
        }

        function calculateTotal(playerIdx) {
            return state.roomData.sessions.reduce((sum, s) => sum + calculateSessionTotal(s, playerIdx), 0);
        }

        function renderCalculate(container) {
            const d = state.roomData;
            const totalGroupScore = d.players.reduce((sum, _, i) => sum + calculateTotal(i), 0);
            const results = d.players.map((name, i) => {
                const personalTotal = calculateTotal(i);
                // å…¬å¼: (4äººæ€»åˆ† - ä¸ªäººæ€»åˆ† * 4) * æ¯åˆ†é‡‘é¢
                let winLoss = (totalGroupScore - (personalTotal * 4)) * d.unitScore;
                // æ ¼å¼åŒ–ï¼šä¿ç•™1ä½å°æ•°ï¼Œå¦‚æœæ˜¯æ•´æ•°åˆ™ä¸æ˜¾ç¤ºå°æ•°
                const formatted = Number(winLoss.toFixed(1));
                return { name, val: formatted };
            });

            // Calculate duration
            let durationStr = "æœªçŸ¥";
            if (d.createdAt && d.lastScoreTime) {
                const diff = d.lastScoreTime - d.createdAt;
                if (diff >= 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    durationStr = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                }
            }

            container.innerHTML = `
                <div class="text-center py-10 flex flex-col min-h-[80vh] justify-center">
                    <h2 class="text-xl font-bold mb-8">è¿™4ä½é“ä»”çš„è¾“èµ¢æƒ…å†µå¦‚ä¸‹</h2>
                    <div class="space-y-6 mb-8">
                        ${results.map(r => `
                            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm px-8">
                                <span class="text-lg font-medium">${r.name}</span>
                                <span class="text-2xl font-black ${r.val > 0 ? 'text-red-500' : r.val < 0 ? 'text-green-600' : 'text-gray-400'}">
                                    ${r.val > 0 ? '+' : ''}${r.val}
                                </span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mb-12">
                         <span class="inline-block bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm font-medium">
                            æ´»åŠ¨æ—¶é•¿ï¼š${durationStr}
                         </span>
                    </div>

                    <button onclick="navigate('room')" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg">è¿”å›æˆ¿é—´</button>
                </div>
            `;
        }

        // --- 7. å¼¹çª—ç³»ç»Ÿ ---
        let modalCallback = null;
        function showModal(title, body, onConfirm, hasInput = false, inputDefault = "") {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = `
                <p class="text-gray-600 mb-4">${body}</p>
                ${hasInput ? `<input type="text" id="modalInput" value="${inputDefault}" class="w-full border p-3 rounded outline-none focus:border-blue-500" autofocus>` : ''}
            `;
            document.getElementById('modal').classList.remove('hidden');
            modalCallback = onConfirm;
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            modalCallback = null;
        }

        document.getElementById('modalConfirmBtn').onclick = () => {
            if (modalCallback) modalCallback();
        };

        // åˆå§‹åŒ–æ¸²æŸ“
        navigate('home');
    </script>
</body>

</html>