<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç­” - å››äººè®°åˆ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        html {
            overflow-y: scroll; /* å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡è½¨é“ï¼Œé˜²æ­¢å¸ƒå±€åç§» */
        }

        .zebra-stripe:nth-child(odd) {
            background-color: #f9fafb;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .active-session {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="loadingStatus" class="fixed top-0 left-0 w-full bg-blue-500 text-white text-xs py-1 text-center hidden">
        æ­£åœ¨è¿æ¥...
    </div>

    <div id="app" class="max-w-md mx-auto p-4 pb-20">
        <div id="view-container"></div>
    </div>

    <div id="modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-xl">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">æç¤º</h3>
            <div id="modalBody" class="mb-6"></div>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelBtn" onclick="App.closeModal()" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-500 text-white rounded">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ==================================================================================
         * æ¨¡å—åŒ–æ¶æ„è®¾è®¡
         * 1. Config: åº”ç”¨é…ç½®ä¸å¸¸é‡
         * 2. Utils: é€šç”¨å·¥å…·å‡½æ•°
         * 3. State: åº”ç”¨çŠ¶æ€ç®¡ç†
         * 4. Logic: çº¯ä¸šåŠ¡é€»è¾‘ (è®¡ç®—ã€è§„åˆ™æ ¡éªŒ)
         * 5. Service: æ•°æ®æœåŠ¡ (Firebase, LocalStorage)
         * 6. View: è§†å›¾æ¸²æŸ“ç»„ä»¶
         * 7. Controller: äº¤äº’é€»è¾‘ä¸æµç¨‹æ§åˆ¶
         * ==================================================================================
         */

        // --- 1. Config: é…ç½®ä¸å¸¸é‡ ---
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyAE2JJQ2w_fLcwl0tlF9qcwRCNes9oICsY",
                authDomain: "calculator-f4869.firebaseapp.com",
                databaseURL: "https://calculator-f4869-default-rtdb.firebaseio.com",
                projectId: "calculator-f4869",
                storageBucket: "calculator-f4869.firebasestorage.app",
                messagingSenderId: "657645216794",
                appId: "1:657645216794:web:1e2092b1fce925b6b09da3",
                measurementId: "G-TM8246NSRV"
            },
            GAME: {
                PLAYER_COUNT: 4,
                WIN_SCORE: 100,
                UNIT_SCORE_DEFAULT: 0.3
            },
            STORAGE_KEYS: {
                ROOM_CACHE_PREFIX: 'room_cache_'
            }
        };

        // --- 2. Utils: å·¥å…·å‡½æ•° ---
        const Utils = {
            /**
             * è§£æè¾“å…¥å­—ç¬¦ä¸²ä¸ºæ•°ç»„
             * @param {string} str - è¾“å…¥å­—ç¬¦ä¸²
             * @returns {Array<string>} - åˆ†å‰²åçš„å­—ç¬¦ä¸²æ•°ç»„
             */
            parseInput(str) {
                return str.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
            },

            /**
             * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸º HH:mm
             * @param {number} timestamp - æ—¶é—´æˆ³
             * @returns {string} - æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
             */
            formatTime(timestamp) {
                if (!timestamp) return "";
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            },

            /**
             * æ ¼å¼åŒ–æŒç»­æ—¶é—´
             * @param {number} start - å¼€å§‹æ—¶é—´æˆ³
             * @param {number} end - ç»“æŸæ—¶é—´æˆ³
             * @returns {string} - æ ¼å¼åŒ–åçš„æŒç»­æ—¶é—´
             */
            formatDuration(start, end) {
                if (!start || !end) return "æœªçŸ¥";
                const diff = end - start;
                if (diff < 0) return "æœªçŸ¥";
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            }
        };

        // --- 3. State: çŠ¶æ€ç®¡ç† ---
        const State = {
            view: 'home', // home, create, join, setup, room, calculate
            roomId: null,
            roomData: null,
            expandedSessions: new Set(), // ä»…æœ¬åœ°å­˜å‚¨ï¼Œè®°å½•å±•å¼€çš„åœºæ¬¡
            showMenu: false, // èœå•æ˜¾ç¤ºçŠ¶æ€

            /**
             * é‡ç½®çŠ¶æ€
             */
            reset() {
                this.roomId = null;
                this.roomData = null;
                this.expandedSessions.clear();
                this.showMenu = false;
            }
        };

        // --- 4. Logic: ä¸šåŠ¡é€»è¾‘ ---
        const Logic = {
            /**
             * è®¡ç®—æŸåœºæ¬¡æŸç©å®¶çš„æ€»åˆ†
             * @param {Object} session - åœºæ¬¡å¯¹è±¡
             * @param {number} playerIdx - ç©å®¶ç´¢å¼•
             * @returns {number} - æ€»åˆ†
             */
            calculateSessionTotal(session, playerIdx) {
                if (!session || !session.rounds) return 0;
                return session.rounds.reduce((sum, r) => {
                    const score = (r.scores && r.scores[playerIdx]) || 0;
                    return sum + score;
                }, 0);
            },

            /**
             * è®¡ç®—æ‰€æœ‰åœºæ¬¡æŸç©å®¶çš„æ€»åˆ†
             * @param {Object} roomData - æˆ¿é—´æ•°æ®
             * @param {number} playerIdx - ç©å®¶ç´¢å¼•
             * @returns {number} - æ€»åˆ†
             */
            calculateTotal(roomData, playerIdx) {
                if (!roomData || !roomData.sessions) return 0;
                return roomData.sessions.reduce((sum, s) => sum + this.calculateSessionTotal(s, playerIdx), 0);
            },

            /**
             * æ£€æŸ¥æœ¬åœºæ˜¯å¦ç»“æŸï¼ˆåˆ†æ•° >= 100ï¼‰
             * @param {Object} session - åœºæ¬¡å¯¹è±¡
             * @returns {boolean} - æ˜¯å¦ç»“æŸ
             */
            isGameOver(session) {
                if (!session || !session.rounds) return false;

                // æ£€æŸ¥æœ€åä¸€å±€æ˜¯å¦å®Œæˆï¼Œå¦‚æœæœªå®Œæˆï¼ˆæœ‰ç©ºåˆ†ï¼‰ï¼Œåˆ™ä¸åˆ¤æ–­ç»“æŸ
                const lastRound = session.rounds[session.rounds.length - 1];
                if (lastRound && (
                    !lastRound.scores || 
                    [0, 1, 2, 3].some(i => lastRound.scores[i] === null || lastRound.scores[i] === undefined)
                )) {
                    return false;
                }

                const totals = [0, 0, 0, 0];
                session.rounds.forEach(r => {
                    const scores = r.scores || [];
                    [0, 1, 2, 3].forEach(i => totals[i] += (scores[i] || 0));
                });

                return totals.some(t => t >= CONFIG.GAME.WIN_SCORE);
            },

            /**
             * æ£€æŸ¥è¯¥å±€æ˜¯å¦ä¸ºæœªå®ŒæˆçŠ¶æ€ (Partial)
             * @param {Object} round - å±€å¯¹è±¡
             * @returns {boolean}
             */
            isRoundPartial(round) {
                if (!round) return false;
                // Firebase å¯èƒ½ä¼šæŠŠ null å­˜ä¸º undefined æˆ– ç¨€ç–æ•°ç»„
                return !round.scores || [0, 1, 2, 3].some(i => round.scores[i] === null || round.scores[i] === undefined);
            },

            /**
             * è®¡ç®—è¾“èµ¢ç»“æœ
             * @param {Object} roomData 
             * @returns {Array} ç»“æœæ•°ç»„
             */
            calculateResults(roomData) {
                const totalGroupScore = roomData.players.reduce((sum, _, i) => sum + this.calculateTotal(roomData, i), 0);
                return roomData.players.map((name, i) => {
                    const personalTotal = this.calculateTotal(roomData, i);
                    // å…¬å¼: (4äººæ€»åˆ† - ä¸ªäººæ€»åˆ† * 4) * æ¯åˆ†é‡‘é¢
                    let winLoss = (totalGroupScore - (personalTotal * 4)) * roomData.unitScore;
                    return { name, val: Number(winLoss.toFixed(1)) };
                });
            },

            /**
             * è®¡ç®—åœºæ¬¡çš„å†å²ç´¯è®¡æ•°æ® (ç”¨äºæ˜ç»†è¡Œ)
             * @param {Object} session 
             * @returns {Array}
             */
            calculateRoundHistory(session) {
                const rounds = session.rounds || [];
                const history = [];
                const currentTotals = [0, 0, 0, 0];

                rounds.forEach((r, rIdx) => {
                    const rawScores = r.scores || [];
                    const scores = [0, 1, 2, 3].map(i => rawScores[i]);
                    const before = [...currentTotals];
                    scores.forEach((s, i) => currentTotals[i] += (s || 0));
                    history.push({
                        roundIndex: rIdx,
                        scores: scores,
                        totalsBefore: before,
                        timestamp: r.timestamp
                    });
                });
                return history;
            }
        };

        // --- 5. Service: æ•°æ®æœåŠ¡ ---
        const Service = {
            db: null,

            /**
             * åˆå§‹åŒ– Firebase
             */
            init() {
                if (!firebase.apps.length) {
                    firebase.initializeApp(CONFIG.FIREBASE);
                }
                this.db = firebase.database();
            },

            /**
             * è·å–æˆ¿é—´å¼•ç”¨
             */
            roomRef(id) {
                return this.db.ref('rooms/' + id);
            },

            /**
             * æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
             */
            async checkRoomExists(id) {
                const snapshot = await this.roomRef(id).once('value');
                return snapshot.exists();
            },

            /**
             * ç›‘å¬æˆ¿é—´æ•°æ®
             */
            subscribeRoom(id, callback) {
                this.roomRef(id).on('value', (snap) => {
                    const val = snap.val();
                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    if (val) {
                        localStorage.setItem(CONFIG.STORAGE_KEYS.ROOM_CACHE_PREFIX + id, JSON.stringify(val));
                    }
                    callback(val);
                });
            },

            /**
             * å–æ¶ˆç›‘å¬
             */
            unsubscribeRoom(id) {
                if (id) this.roomRef(id).off();
            },

            /**
             * ä»ç¼“å­˜è¯»å–æˆ¿é—´æ•°æ®
             */
            loadFromCache(id) {
                try {
                    const cached = localStorage.getItem(CONFIG.STORAGE_KEYS.ROOM_CACHE_PREFIX + id);
                    return cached ? JSON.parse(cached) : null;
                } catch (e) {
                    console.error("Cache load error", e);
                    return null;
                }
            },

            /**
             * åˆ›å»ºæˆ¿é—´
             */
            createRoom(id, players) {
                return this.roomRef(id).update({
                    players: players,
                    unitScore: CONFIG.GAME.UNIT_SCORE_DEFAULT,
                    currentSessionId: 1,
                    sessions: [{ id: 1, rounds: [] }],
                    createdAt: Date.now()
                });
            },

            /**
             * åˆ é™¤æˆ¿é—´
             */
            deleteRoom(id) {
                return this.roomRef(id).remove();
            },

            /**
             * è·å–æ‰€æœ‰æˆ¿é—´ï¼ˆç”¨äºèœå•ï¼‰
             */
            async getAllRooms() {
                const snapshot = await this.db.ref('rooms').once('value');
                return snapshot.val();
            }
        };

        // --- 6. View: è§†å›¾æ¸²æŸ“ ---
        const View = {
            container: document.getElementById('view-container'),
            loading: document.getElementById('loadingStatus'),
            modalCallback: null,

            init() {
                const btn = document.getElementById('modalConfirmBtn');
                if (btn) {
                    btn.onclick = () => {
                        if (this.modalCallback) this.modalCallback();
                    };
                }
            },

            /**
             * æ˜¾ç¤º/éšè—åŠ è½½æ¡
             */
            showLoading(show) {
                this.loading.classList.toggle('hidden', !show);
            },

            /**
             * ä¸»æ¸²æŸ“å…¥å£
             */
            render() {
                if (State.view === 'home') this.renderHome();
                else if (State.view === 'create' || State.view === 'join') this.renderEntry();
                else if (State.view === 'setup') this.renderSetup();
                else if (State.view === 'room') this.renderRoom();
                else if (State.view === 'calculate') this.renderCalculate();
            },

            renderHome() {
                this.container.innerHTML = `
                    <div class="flex flex-col min-h-[80vh]">
                        <div class="flex justify-end pt-2 relative">
                            <button onclick="App.toggleMenu()" class="p-2 text-gray-600 hover:text-gray-900 focus:outline-none transition-colors rounded-full hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                            </button>
                            ${State.showMenu ? this.renderMenu() : ''}
                        </div>
                        <div class="flex-1 flex flex-col justify-center pb-20">
                            <h1 class="text-5xl font-black text-center mb-16 tracking-widest text-blue-600 drop-shadow-sm">æ‰“ç­”</h1>
                            <div class="flex flex-col space-y-6 px-8">
                                <button onclick="App.navigate('create')" class="bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">â•</span> åˆ›å»ºæˆ¿é—´
                                </button>
                                <button onclick="App.navigate('join')" class="bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 py-5 rounded-2xl font-bold text-xl shadow-md active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">ğŸ”</span> åŠ å…¥æˆ¿é—´
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderMenu() {
                return `
                    <div class="absolute right-0 top-12 w-48 bg-white border border-gray-200 rounded-lg shadow-2xl z-50 text-base overflow-hidden animate-fade-in-down">
                        <button onclick="App.menuViewRooms()" class="block w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 hover:text-blue-600 border-b border-gray-100 transition-colors flex items-center">
                            <span class="mr-2">ğŸ </span> æŸ¥çœ‹ç°æœ‰æˆ¿é—´
                        </button>
                        <button onclick="App.menuCleanRoom()" class="block w-full text-left px-4 py-3 hover:bg-red-50 text-gray-700 hover:text-red-600 border-b border-gray-100 transition-colors flex items-center">
                            <span class="mr-2">ğŸ—‘ï¸</span> æ¸…ç†æˆ¿é—´
                        </button>
                        <button onclick="App.menuUsage()" class="block w-full text-left px-4 py-3 hover:bg-green-50 text-gray-700 hover:text-green-600 border-b border-gray-100 transition-colors flex items-center">
                            <span class="mr-2">ğŸ“–</span> ä½¿ç”¨æ–¹æ³•
                        </button>
                        <button onclick="App.menuAbout()" class="block w-full text-left px-4 py-3 hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition-colors flex items-center">
                            <span class="mr-2">â„¹ï¸</span> å…³äº
                        </button>
                    </div>
                `;
            },

            renderEntry() {
                const isCreate = State.view === 'create';
                this.container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-2xl font-bold mb-6 text-center">${isCreate ? 'åˆ›å»º' : 'åŠ å…¥'}æˆ¿é—´</h2>
                        <input type="number" id="roomNumInput" placeholder="è¾“å…¥æˆ¿é—´å·(æ•°å­—)" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 text-center text-xl focus:border-blue-500 outline-none">
                        <button onclick="App.handleJoinRoom(document.getElementById('roomNumInput').value, ${isCreate})" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">ç¡®è®¤</button>
                        <button onclick="App.navigate('home')" class="w-full text-gray-500 mt-4 text-center">è¿”å›</button>
                    </div>
                `;
            },

            renderSetup() {
                this.container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-xl font-bold mb-4">æ–°æˆ¿é—´è®¾ç½®</h2>
                        <p class="text-gray-600 mb-2 text-sm">è¯·è¾“å…¥4ä¸ªé“ä»”åå­—ï¼ˆç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼‰</p>
                        <input type="text" id="playerNames" placeholder="å°ç‹ å°æ é˜¿å¼º å¤§å£®" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 outline-none focus:border-blue-500">
                        <button onclick="App.submitSetup(document.getElementById('playerNames').value)" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">è¿›å…¥æˆ¿é—´</button>
                    </div>
                `;
            },

            renderRoom() {
                const d = State.roomData;
                const players = d.players;
                const sessions = [...d.sessions].reverse(); // æœ€æ–°åœºæ¬¡åœ¨ä¸Š

                let html = `
                    <div class="relative flex justify-center items-center mb-6">
                        <h1 class="text-3xl font-black text-blue-600">æ‰“ç­”</h1>
                        <button onclick="App.exitRoom()" class="absolute right-0 text-red-500 font-medium text-base border border-red-200 px-3 py-1 rounded">é€€å‡ºæˆ¿é—´</button>
                    </div>

                    <div id="pullToRefreshIndicator" class="hidden text-center text-gray-500 text-sm py-2">
                        ä¸‹æ‹‰åˆ·æ–°...
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-bold">æ¯åˆ†é‡‘é¢:</span>
                                <span class="font-bold text-lg mx-2">${d.unitScore}</span>
                                <button onclick="App.openUnitScoreModal()" class="text-blue-500 text-base font-bold">ä¿®æ”¹</button>
                            </div>
                            <button onclick="App.refreshRoom()" class="bg-green-500 text-white text-sm px-3 py-1 rounded shadow">åˆ·æ–°æ•°æ®</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 text-center text-sm">
                        <table class="w-full border-collapse table-fixed">
                            <thead>
                                <tr class="bg-gray-800 text-white">
                                    <th class="w-1/6 py-3 px-1 font-medium text-base text-center">åœºæ¬¡</th>
                                    ${players.map(p => `<th class="w-1/6 py-3 px-1 font-medium text-base text-center">${p}</th>`).join('')}
                                    <th class="w-1/6 py-3 px-1">
                                        <button onclick="App.startNewSession()" class="text-green-600 font-bold text-base cursor-pointer hover:text-green-800">åŠ åœº</button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-blue-50 font-bold border-b-2 border-blue-100 text-base">
                                    <td class="py-4 text-center">å…¨éƒ¨</td>
                                    ${players.map((_, i) => `<td class="text-center">${Logic.calculateTotal(d, i)}</td>`).join('')}
                                    <td class="text-blue-600 cursor-pointer font-bold" onclick="App.navigate('calculate')">è®¡ç®—</td>
                                </tr>
                                ${sessions.map(s => this.renderSessionRow(s, d.players, d.currentSessionId)).join('')}
                            </tbody>
                        </table>
                    </div>`;

                this.container.innerHTML = html;
                this.setupPullToRefresh();
            },

            /**
             * æ¸²æŸ“åœºæ¬¡è¡Œ
             */
            renderSessionRow(session, players, currentId) {
                const isCurrent = session.id === currentId;
                const isExpanded = State.expandedSessions.has(session.id);
                
                let html = this.renderSessionSummary(session, players, isCurrent, isExpanded);

                if (isExpanded) {
                    if (isCurrent) {
                        html += this.renderCurrentRoundRow(session, players);
                    }
                    html += this.renderHistoryRows(session, players, isCurrent);
                }
                return html;
            },

            renderSessionSummary(session, players, isCurrent, isExpanded) {
                const rowClass = isCurrent 
                    ? 'bg-yellow-50 active-session border-b border-yellow-100' 
                    : 'zebra-stripe';
                
                return `
                    <tr class="${rowClass} text-base">
                        <td class="py-4 font-bold text-center">${session.id}</td>
                        ${players.map((_, i) => `<td class="text-center">${Logic.calculateSessionTotal(session, i)}</td>`).join('')}
                        <td class="text-blue-500 font-medium">
                            <button onclick="App.toggleSession(${session.id})" class="font-bold text-sm">${isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}</button>
                        </td>
                    </tr>
                `;
            },

            renderCurrentRoundRow(session, players) {
                const rounds = session.rounds || [];
                const lastRound = rounds[rounds.length - 1];
                const isPartial = Logic.isRoundPartial(lastRound);
                const sessionIdx = State.roomData.sessions.findIndex(s => s.id === session.id);

                return `<tr class="text-sm text-gray-500 bg-white font-bold">
                    <td class="py-2 text-center">æœ¬å±€</td>
                    ${players.map((_, i) => {
                        const total = Logic.calculateSessionTotal(session, i);
                        
                        let btnColorClass = "text-blue-600 hover:text-blue-800"; // é»˜è®¤æ·±è‰²
                        let leftVal = total;
                        let rightVal = "";
                        let isEmpty = false;

                        if (isPartial) {
                            const s = lastRound.scores ? lastRound.scores[i] : undefined;
                            if (s === null || s === undefined) {
                                isEmpty = true;
                            } else {
                                btnColorClass = "text-blue-400 hover:text-blue-600";
                                leftVal = total - s;
                                rightVal = s;
                            }
                        }

                        let btnContent = "";
                        if (!isEmpty) {
                            btnContent = `
                            <div class="flex items-center justify-start w-full font-mono">
                                <div class="w-[3ch] text-right">${leftVal}</div>
                                <div class="px-1 text-center">-</div>
                                <div class="w-[2ch] text-left">${rightVal}</div>
                            </div>`;
                        }

                        return `<td class="text-left pl-2">
                            <button onclick="App.openAddSingleScoreModal(${sessionIdx}, ${i})" class="${btnColorClass} font-bold px-1 py-1 rounded w-full text-sm whitespace-nowrap block">${btnContent}</button>
                        </td>`;
                    }).join('')}
                    <td class="pl-0"><button class="text-sm text-blue-500 font-bold whitespace-nowrap" onclick="App.openScoreModal(${sessionIdx})">è®°åˆ†</button></td>
                </tr>`;
            },

            renderHistoryRows(session, players, isCurrent) {
                const history = Logic.calculateRoundHistory(session);
                const sessionIdx = State.roomData.sessions.findIndex(s => s.id === session.id);
                
                return history.reverse().map(rData => {
                    const timeStr = Utils.formatTime(rData.timestamp);
                    const actionCol = isCurrent 
                        ? `<div class="flex flex-col items-center">
                            <button class="text-sm text-blue-400 font-bold mb-1 whitespace-nowrap" onclick="App.openScoreModal(${sessionIdx}, ${rData.roundIndex})">ä¿®æ”¹</button>
                            <span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>
                           </div>`
                        : `<span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>`;

                    return `<tr class="text-sm text-gray-500 bg-white">
                        <td class="py-2 text-center">å±€ ${rData.roundIndex + 1}</td>
                        ${rData.scores.map((s, pi) => `<td class="text-left pl-2">${this.renderScoreCell(s, pi, rData.totalsBefore[pi], isCurrent, sessionIdx, rData.roundIndex)}</td>`).join('')}
                        <td class="pl-0">${actionCol}</td>
                    </tr>`;
                }).join('');
            },

            renderScoreCell(score, playerIdx, beforeTotal, isCurrent, sessionIdx, roundIndex) {
                 const isScoreEmpty = score === null || score === undefined;
                 const rightVal = isScoreEmpty ? "" : score;
                 
                 const contentInner = `
                     <div class="flex items-center justify-start w-full ${!isCurrent ? 'px-1' : ''} font-mono">
                         <div class="w-[3ch] text-right">${beforeTotal}</div>
                         <div class="px-1 text-center">-</div>
                         <div class="w-[2ch] text-left">${rightVal}</div>
                     </div>`;

                 if (isCurrent) {
                     const btnColorClass = isScoreEmpty ? "text-blue-600 hover:text-blue-800" : "text-blue-400 hover:text-blue-600";
                     return `<button onclick="App.openSingleScoreModal(${sessionIdx}, ${roundIndex}, ${playerIdx})" class="${btnColorClass} font-bold px-1 py-1 rounded w-full text-sm whitespace-nowrap block">${contentInner}</button>`;
                 } else {
                     return contentInner;
                 }
            },

            renderCalculate() {
                const d = State.roomData;
                const results = Logic.calculateResults(d);
                const durationStr = Utils.formatDuration(d.createdAt, d.lastScoreTime);

                this.container.innerHTML = `
                    <div class="text-center py-10 flex flex-col min-h-[80vh] justify-center">
                        <h2 class="text-xl font-bold mb-8">è¿™4ä½é“ä»”çš„è¾“èµ¢æƒ…å†µå¦‚ä¸‹</h2>
                        <div class="space-y-6 mb-8">
                            ${results.map(r => `
                                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm px-8">
                                    <span class="text-base font-medium">${r.name}</span>
                                    <span class="text-xl font-black ${r.val > 0 ? 'text-red-500' : r.val < 0 ? 'text-green-600' : 'text-gray-400'}">
                                        ${r.val > 0 ? '+' : ''}${r.val}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mb-12">
                             <span class="inline-block bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm font-medium">
                                æ´»åŠ¨æ—¶é•¿ï¼š${durationStr}
                             </span>
                        </div>
                        <button onclick="App.navigate('room')" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg">è¿”å›æˆ¿é—´</button>
                    </div>
                `;
            },

            /**
             * æ˜¾ç¤ºæ¨¡æ€æ¡†
             */
            showModal(title, body, onConfirm, hasInput = false, inputDefault = "", confirmText = "ç¡®è®¤", cancelText = "å–æ¶ˆ") {
                const titleEl = document.getElementById('modalTitle');
                const isTip = title === "æç¤º";
                
                if (isTip) {
                    titleEl.classList.add('hidden');
                } else {
                    titleEl.innerText = title;
                    titleEl.classList.remove('hidden');
                }

                const bodyClass = isTip ? "text-gray-900 font-bold mb-4 text-lg" : "text-gray-600 mb-4";

                document.getElementById('modalBody').innerHTML = `
                    <div class="${bodyClass}">${body}</div>
                    ${hasInput ? `<input type="text" id="modalInput" value="${inputDefault}" class="w-full border p-3 rounded outline-none focus:border-blue-500" autofocus>` : ''}
                `;
                
                const confirmBtn = document.getElementById('modalConfirmBtn');
                if (confirmText) {
                    confirmBtn.innerText = confirmText;
                    confirmBtn.classList.remove('hidden');
                } else {
                    confirmBtn.classList.add('hidden');
                }
                
                document.getElementById('modalCancelBtn').innerText = cancelText;
                document.getElementById('modal').classList.remove('hidden');
                
                this.modalCallback = onConfirm;
            },

            showRoomListModal(rooms, isCleanMode) {
                let content = "æš‚æ— æˆ¿é—´";
                if (rooms) {
                    content = Object.keys(rooms).map(id => {
                        const r = rooms[id];
                        const players = r.players ? r.players.join('ï¼Œ') : 'ï¼ˆæœªè®¾ç½®ç©å®¶ï¼‰';
                        if (isCleanMode) {
                            return `
                            <div class="flex justify-between items-center mb-2 border-b pb-1">
                                <div class="flex-1">
                                    <strong>æˆ¿é—´å·ï¼š${id}</strong><br>
                                    <span class="text-xs text-gray-500">${players}</span>
                                </div>
                                <button onclick="App.confirmDeleteRoom('${id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded ml-2 shadow-sm transition-colors">åˆ é™¤</button>
                            </div>`;
                        } else {
                            return `<div class="mb-2 border-b pb-1"><strong>æˆ¿é—´å·ï¼š${id}</strong><br><span class="text-xs text-gray-500">${players}</span></div>`;
                        }
                    }).join('');
                }
                const title = isCleanMode ? "æ¸…ç†æˆ¿é—´åˆ—è¡¨" : "ç°æœ‰æˆ¿é—´";
                this.showModal(title, content, this.closeModal);
            },

            showUsageModal() {
                const content = `
                    <div class="text-sm space-y-3 text-left">
                        <p><strong>1. å¦‚ä½•åˆ›å»ºæˆ¿é—´ï¼š</strong>ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>2. å¦‚ä½•åŠ å…¥æˆ¿é—´ï¼š</strong>ç‚¹å‡»"åŠ å…¥æˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>3. å¦‚ä½•ä¿®æ”¹æ¯åˆ†é‡‘é¢ï¼š</strong>ç‚¹å‡»"æ¯åˆ†é‡‘é¢"åé¢çš„"ä¿®æ”¹"æŒ‰é’®ï¼Œè¾“å…¥æ–°çš„é‡‘é¢ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>4. å¦‚ä½•æ·»åŠ åœºæ¬¡ï¼š</strong>ç‚¹å‡»è¡¨æ ¼å¤´éƒ¨çš„"åŠ åœº"æŒ‰é’®ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>5. å¦‚ä½•æ·»åŠ æœ¬å±€è®°åˆ†ï¼š</strong>ç‚¹å‡»æœ€æ–°å±€çš„"è®°åˆ†"æŒ‰é’®ï¼ŒæŒ‰é¡ºåºè¾“å…¥ç©å®¶Aã€Bã€Cã€Dçš„å¾—åˆ†ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>6. å¦‚ä½•è®¡ç®—ç»“æœï¼š</strong>ç‚¹å‡»"è®¡ç®—"æŒ‰é’®ï¼Œå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºè®¡ç®—ç»“æœã€‚</p>
                        <p><strong>7. è®¡ç®—å…¬å¼ï¼š</strong><br>
                        ä¸ªäººè¾“èµ¢ = (4äººæ€»åˆ† - ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° Ã— 4) Ã— æ¯åˆ†é‡‘é¢<br>
                        <span class="text-xs text-gray-400">ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° = ä¸ªäººåœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                        4äººæ€»åˆ† = æ‰€æœ‰ç©å®¶åœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                        æ¯åˆ†é‡‘é¢ = ç”¨æˆ·åœ¨è½¯ä»¶ä¸­è®¾ç½®çš„æ¯åˆ†é‡‘é¢</span></p>
                    </div>
                `;
                this.showModal("ä½¿ç”¨æ–¹æ³•", content, this.closeModal);
            },

            showAboutModal() {
                const content = `
                    <div class="text-left space-y-2">
                        <p><strong>è½¯ä»¶åç§°ï¼š</strong>æ‰“ç­”</p>
                        <p><strong>ä½œè€…ï¼š</strong>Kaishen</p>
                        <p><strong>è”ç³»ä½œè€…ï¼š</strong>å…ˆçœ‹"ä½¿ç”¨æ–¹æ³•"ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œå†è”ç³»ä½œè€…ã€‚</p>
                        <p><strong>è½¯ä»¶ç›®çš„ï¼š</strong>æä¾›ä¸€ä¸ªæ–¹ä¾¿çš„æ‰“ç­”è®°å½•å’Œè®°åˆ†è½¯ä»¶ã€‚</p>
                        <p class="mt-4 italic text-gray-500 text-center">"èµ¢é’±éæˆ‘æ„ï¼Œä½†æ„¿å‹é•¿å­˜ã€‚"</p>
                    </div>
                `;
                this.showModal("å…³äº", content, this.closeModal);
            },

            showDeleteRoomModal(roomId, onConfirm) {
                 const content = `ç¡®å®šè¦åˆ é™¤æˆ¿é—´ <span class="font-bold text-red-500">${roomId}</span> åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ<br><br><span class="text-xs text-gray-500">æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</span>`;
                 this.showModal("ç¡®è®¤åˆ é™¤", content, onConfirm);
            },

            showRoomExistsModal(id, onEnter, onRecreate) {
                const modalContent = `
                    <div class="text-left">
                        <p class="mb-4">æˆ¿é—´å· <strong>${id}</strong> å·²å­˜åœ¨ã€‚</p>
                        <p class="mb-4 text-sm text-gray-600">æ‚¨å¯ä»¥é€‰æ‹©ï¼š</p>
                        <div class="space-y-2">
                            <button id="modalRecreateBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">é‡æ–°åˆ›å»º (è¿”å›)</button>
                            <button id="modalEnterBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600">è¿›å…¥è¯¥æˆ¿é—´</button>
                        </div>
                    </div>
                `;
                this.showModal("æˆ¿é—´å·²å­˜åœ¨", modalContent, null);
                
                setTimeout(() => {
                    const rBtn = document.getElementById('modalRecreateBtn');
                    const eBtn = document.getElementById('modalEnterBtn');
                    if (rBtn) rBtn.onclick = onRecreate;
                    if (eBtn) eBtn.onclick = onEnter;
                }, 0);
            },

            showUnitScoreModal(currentVal, onConfirm) {
                this.showModal("ä¿®æ”¹æ¯åˆ†é‡‘é¢", "è¯·è¾“å…¥æ¯åˆ†å¤šå°‘é’±ï¼š", () => {
                    const val = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(val) || val <= 0) return alert("è¯·è¾“å…¥æ­£æ•°");
                    onConfirm(val);
                }, true, currentVal);
            },

            showScoreModal(isEdit, defaultVal, onConfirm) {
                 this.showModal(isEdit ? "ä¿®æ”¹åˆ†æ•°" : "æ·»åŠ è®°åˆ†", "è¯·è¾“å…¥4ä¸ªåˆ†æ•°ï¼ˆç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼‰ï¼š", () => {
                    const scores = Utils.parseInput(document.getElementById('modalInput').value).map(Number);
                    if (scores.length !== 4 || scores.some(isNaN)) return alert("è¯·è¾“å…¥4ä¸ªæœ‰æ•ˆæ•°å­—");
                    onConfirm(scores);
                }, true, defaultVal);
            },

            showSingleScoreInputModal(title, defaultVal, onConfirm) {
                 this.showModal(title, (defaultVal === "" || defaultVal === undefined) ? "è¯·è¾“å…¥åˆ†æ•°ï¼š" : "è¯·è¾“å…¥æ–°çš„åˆ†æ•°ï¼š", () => {
                    const val = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(val)) return alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—");
                    onConfirm(val);
                }, true, defaultVal);
            },

            showGameOverModal(onModify, onNext) {
                const modalContent = `
                    <div class="text-center">
                        <p class="text-xl font-bold text-red-500 mb-4">æœ¬åœºå·²ç»“æŸ</p>
                        <div class="space-y-3">
                            <button id="modalModifyBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">è¿”å›</button>
                            <button id="modalNextBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600">å¼€å¯ä¸‹ä¸€åœºæ¬¡</button>
                        </div>
                    </div>
                `;
                
                const titleEl = document.getElementById('modalTitle');
                if (titleEl) {
                    titleEl.innerText = "æç¤º";
                    titleEl.classList.remove('hidden');
                }
                
                const bodyEl = document.getElementById('modalBody');
                if (bodyEl) bodyEl.innerHTML = modalContent;
                
                const modalEl = document.getElementById('modal');
                if (modalEl) modalEl.classList.remove('hidden');
                
                const footer = document.querySelector('#modal .flex.justify-end');
                if(footer) footer.style.display = 'none';
                
                setTimeout(() => {
                    const mBtn = document.getElementById('modalModifyBtn');
                    const nBtn = document.getElementById('modalNextBtn');
                    if (mBtn) mBtn.onclick = onModify;
                    if (nBtn) nBtn.onclick = onNext;
                }, 0);
            },

            /**
             * ä¸‹æ‹‰åˆ·æ–°è®¾ç½®
             */
            setupPullToRefresh() {
                if (this._pullToRefreshSetup) return;
                this._pullToRefreshSetup = true;

                let touchStartY = 0;
                const threshold = 80;

                window.addEventListener('touchstart', e => {
                    if (window.scrollY === 0 && e.changedTouches && e.changedTouches.length > 0) {
                        touchStartY = e.changedTouches[0].screenY;
                    }
                }, { passive: true });

                window.addEventListener('touchmove', e => {
                    const indicator = document.getElementById('pullToRefreshIndicator');
                    if (!indicator) return;

                    if (window.scrollY === 0 && touchStartY > 0 && e.changedTouches && e.changedTouches.length > 0) {
                        const currentY = e.changedTouches[0].screenY;
                        if (currentY > touchStartY) indicator.classList.remove('hidden');
                    }
                }, { passive: true });

                window.addEventListener('touchend', e => {
                    const indicator = document.getElementById('pullToRefreshIndicator');
                    if (!indicator) {
                        touchStartY = 0;
                        return;
                    }

                    if (window.scrollY === 0 && touchStartY > 0 && e.changedTouches && e.changedTouches.length > 0) {
                        const touchEndY = e.changedTouches[0].screenY;
                        if (touchEndY - touchStartY > threshold) {
                            indicator.innerText = "åˆ·æ–°ä¸­...";
                            if (window.App && window.App.refreshRoom) {
                                window.App.refreshRoom();
                            }
                            setTimeout(() => {
                                 const ind = document.getElementById('pullToRefreshIndicator');
                                 if (ind) {
                                     ind.classList.add('hidden');
                                     ind.innerText = "ä¸‹æ‹‰åˆ·æ–°...";
                                 }
                            }, 1000);
                        } else {
                            indicator.classList.add('hidden');
                        }
                    }
                    touchStartY = 0;
                }, { passive: true });
            },

            showCleanRoomAuthModal(onConfirm) {
                this.showModal("æ¸…ç†æˆ¿é—´", "è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š", () => {
                    const pwd = document.getElementById('modalInput').value;
                    onConfirm(pwd);
                }, true);
            },

            showStartSessionConfirmModal(onConfirm) {
                this.showModal("ç¡®è®¤å¼€å§‹æ–°åœºæ¬¡ï¼Ÿ", "å¼€å§‹åå°†æ— æ³•ä¿®æ”¹ä¹‹å‰çš„åœºæ¬¡æ•°æ®ã€‚", onConfirm);
            },

            showWaitModal(onConfirm) {
                this.showModal("æç¤º", "è¯·ç­‰å¾…å…¶ä»–äººè®°å®Œåˆ†", onConfirm, false, "", null, "è¿”å›");
            },

            showEditScoreConfirmModal(onConfirm) {
                this.showModal("æç¤º", "è¿™ä¸æ˜¯æ–°å¢åˆ†æ•°ï¼Œç¡®å®šä¿®æ”¹å—ï¼Ÿ", onConfirm, false, "", "ç¡®å®šä¿®æ”¹", "è¿”å›");
            },

            showMessageModal(title, content, onConfirm) {
                this.showModal(title, content, onConfirm);
            },

            closeModal() {
                document.getElementById('modal').classList.add('hidden');
                const footer = document.querySelector('#modal .flex.justify-end');
                if(footer) footer.style.display = 'flex';
                this.modalCallback = null;
            }
        };

        // --- 7. Controller: åº”ç”¨æ§åˆ¶å™¨ ---
        const App = {
            /**
             * åˆå§‹åŒ–åº”ç”¨
             */
            init() {
                Service.init();
                View.init();
                this.navigate('home');
            },

            /**
             * å¯¼èˆªåˆ‡æ¢
             */
            navigate(view) {
                State.view = view;
                View.render();
            },

            /**
             * åˆ‡æ¢èœå•æ˜¾ç¤º
             */
            toggleMenu() {
                State.showMenu = !State.showMenu;
                View.render();
            },

            /**
             * å¤„ç†åŠ å…¥æˆ¿é—´é€»è¾‘
             */
            async handleJoinRoom(id, isCreate = false) {
                if (!/^\d+$/.test(id)) return alert("æˆ¿é—´å·å¿…é¡»æ˜¯æ•°å­—");
                View.showLoading(true);

                const exists = await Service.checkRoomExists(id);

                if (isCreate && exists) {
                    View.showRoomExistsModal(id, 
                        () => this.enterRoom(id), 
                        () => this.closeModal()
                    );
                    return;
                } else if (!isCreate && !exists) {
                    View.showLoading(false);
                    return View.showMessageModal("æç¤º", "æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æˆ¿é—´å·", this.closeModal);
                }

                this.enterRoom(id);
            },

            /**
             * è¿›å…¥æˆ¿é—´æ ¸å¿ƒé€»è¾‘
             */
            enterRoom(id) {
                this.closeModal();
                State.roomId = id;

                // 1. å°è¯•ç¼“å­˜åŠ è½½
                const cachedData = Service.loadFromCache(id);
                if (cachedData && cachedData.players) {
                    State.roomData = cachedData;
                    View.showLoading(false);
                    this.initExpandedSessions();
                    if (State.view !== 'calculate') {
                        State.view = 'room';
                        View.render();
                    }
                }

                // 2. å»ºç«‹å®æ—¶è¿æ¥
                Service.subscribeRoom(id, (val) => {
                    State.roomData = val;
                    View.showLoading(false);

                    if (!State.roomData || !State.roomData.players) {
                        this.navigate('setup');
                    } else {
                        this.initExpandedSessions();
                        if (State.view === 'room') View.render();
                        else if (State.view !== 'calculate') this.navigate('room');
                    }
                });
            },

            initExpandedSessions() {
                if (State.roomData.sessions && State.roomData.sessions.length > 0) {
                    const latestSessionId = State.roomData.sessions[State.roomData.sessions.length - 1].id;
                    State.expandedSessions.add(latestSessionId);
                }
            },

            exitRoom() {
                Service.unsubscribeRoom(State.roomId);
                State.reset();
                this.navigate('home');
            },

            refreshRoom() {
                if (State.roomId) this.enterRoom(State.roomId);
            },

            /**
             * æäº¤æ–°æˆ¿é—´è®¾ç½®
             */
            submitSetup(namesStr) {
                const names = Utils.parseInput(namesStr);
                if (names.length !== 4) return alert("è¯·è¾“å…¥æ­£å¥½4ä¸ªé“ä»”çš„åå­—");
                Service.createRoom(State.roomId, names);
            },

            /**
             * å¼€å¯æ–°åœºæ¬¡
             */
            startNewSession(skipConfirm = false) {
                const doStart = () => {
                    const sessions = State.roomData.sessions || [];
                    const newId = sessions.length + 1;
                    sessions.push({ id: newId, rounds: [] });
                    Service.roomRef(State.roomId).update({
                        sessions: sessions,
                        currentSessionId: newId
                    });
                    this.closeModal();
                };

                if (skipConfirm) doStart();
                else View.showStartSessionConfirmModal(doStart);
            },

            /**
             * åˆ‡æ¢åœºæ¬¡å±•å¼€/æ”¶èµ·
             */
            toggleSession(id) {
                if (State.expandedSessions.has(id)) State.expandedSessions.delete(id);
                else State.expandedSessions.add(id);
                View.render();
            },

            /**
             * æ‰“å¼€ä¿®æ”¹æ¯åˆ†é‡‘é¢å¼¹çª—
             */
            openUnitScoreModal() {
                View.showUnitScoreModal(State.roomData.unitScore, (val) => {
                    Service.roomRef(State.roomId).update({ unitScore: parseFloat(val.toFixed(1)) });
                    this.closeModal();
                });
            },

            /**
             * æ‰“å¼€è®°åˆ†å¼¹çª— (Session Level)
             */
            openScoreModal(sessionIdx, roundIdx = null) {
                const isEdit = roundIdx !== null;
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];

                // å¦‚æœæ˜¯æ·»åŠ æ–°åˆ†æ•°ï¼Œæ£€æŸ¥ä¸Šä¸€å±€æ˜¯å¦æœªå®Œæˆ
                if (!isEdit && currentRounds.length > 0) {
                    const lastRound = currentRounds[currentRounds.length - 1];
                    if (Logic.isRoundPartial(lastRound)) {
                        View.showWaitModal(() => this.closeModal());
                        return;
                    }
                }

                const defaultValue = isEdit ? currentRounds[roundIdx].scores.join(' ') : "";

                View.showScoreModal(isEdit, defaultValue, (scores) => {
                    if (isEdit) {
                        currentRounds[roundIdx].scores = scores;
                        currentRounds[roundIdx].timestamp = Date.now();
                    } else {
                        currentRounds.push({ 
                            roundIndex: currentRounds.length, 
                            scores: scores,
                            timestamp: Date.now()
                        });
                    }

                    Service.roomRef(State.roomId).child(`sessions/${sessionIdx}/rounds`).set(currentRounds);
                    Service.roomRef(State.roomId).child('lastScoreTime').set(Date.now());
                    this.closeModal();
                    setTimeout(() => this.checkGameOver(sessionIdx), 500);
                });
            },

            /**
             * æ‰“å¼€å•äººè®°åˆ†å¼¹çª— (æœ¬å±€æˆ–æ˜ç»†)
             */
            openAddSingleScoreModal(sessionIdx, playerIdx) {
                const playerName = State.roomData.players[playerIdx];
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                const lastRound = currentRounds[currentRounds.length - 1];

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰åˆ†æ•°çš„è¯¯è§¦ä¿æŠ¤
                if (lastRound && lastRound.scores && (lastRound.scores[playerIdx] !== null && lastRound.scores[playerIdx] !== undefined)) {
                    if (Logic.isRoundPartial(lastRound)) {
                        View.showWaitModal(() => this.closeModal());
                        return;
                    }
                }
                this.showInputModal(sessionIdx, playerIdx, playerName);
            },

            showInputModal(sessionIdx, playerIdx, playerName) {
                View.showSingleScoreInputModal(`æ·»åŠ  ${playerName} çš„åˆ†æ•°`, "", (val) => {
                    const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                    let lastRound = currentRounds[currentRounds.length - 1];
                    let isPartial = Logic.isRoundPartial(lastRound);

                    if (isPartial) {
                        if (!lastRound.scores) lastRound.scores = [null, null, null, null];
                        lastRound.scores[playerIdx] = val;
                        lastRound.timestamp = Date.now();
                    } else {
                        const newScores = [null, null, null, null];
                        newScores[playerIdx] = val;
                        currentRounds.push({ 
                            roundIndex: currentRounds.length, 
                            scores: newScores,
                            timestamp: Date.now()
                        });
                    }

                    Service.roomRef(State.roomId).child(`sessions/${sessionIdx}/rounds`).set(currentRounds);
                    Service.roomRef(State.roomId).child('lastScoreTime').set(Date.now());
                    this.closeModal();
                    setTimeout(() => this.checkGameOver(sessionIdx), 500);
                });
            },

            /**
             * æ‰“å¼€ä¿®æ”¹å•äººåˆ†æ•°å¼¹çª— (å†å²è®°å½•)
             */
            openSingleScoreModal(sessionIdx, roundIdx, playerIdx) {
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                const currentScore = currentRounds[roundIdx].scores[playerIdx];
                const playerName = State.roomData.players[playerIdx];

                if (currentScore !== null && currentScore !== undefined) {
                     View.showEditScoreConfirmModal(() => {
                         this.closeModal();
                         setTimeout(() => this.showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore), 200);
                     });
                     return;
                }
                this.showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore);
            },

            showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore) {
                View.showSingleScoreInputModal(`ä¿®æ”¹ ${playerName} çš„åˆ†æ•°`, currentScore, (val) => {
                    const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                    currentRounds[roundIdx].scores[playerIdx] = val;
                    currentRounds[roundIdx].timestamp = Date.now();

                    Service.roomRef(State.roomId).child(`sessions/${sessionIdx}/rounds`).set(currentRounds);
                    Service.roomRef(State.roomId).child('lastScoreTime').set(Date.now());
                    this.closeModal();
                    setTimeout(() => this.checkGameOver(sessionIdx), 500);
                });
            },

            /**
             * æ£€æŸ¥æ¸¸æˆç»“æŸ
             */
            checkGameOver(sessionIdx) {
                const session = State.roomData.sessions[sessionIdx];
                if (Logic.isGameOver(session)) {
                    View.showGameOverModal(
                        () => this.closeModal(), 
                        () => this.startNewSession(true)
                    );
                }
            },

            /**
             * èœå•ç›¸å…³åŠŸèƒ½
             */
            async menuViewRooms() {
                this.toggleMenu();
                View.showLoading(true);
                const rooms = await Service.getAllRooms();
                View.showLoading(false);
                View.showRoomListModal(rooms, false);
            },

            menuCleanRoom() {
                this.toggleMenu();
                View.showCleanRoomAuthModal((pwd) => {
                    if (pwd !== 'clean') {
                        View.showMessageModal("é”™è¯¯", "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚", this.closeModal);
                        return;
                    }
                    this.closeModal();
                    setTimeout(() => this.showCleanRoomList(), 200);
                });
            },

            async showCleanRoomList() {
                View.showLoading(true);
                const rooms = await Service.getAllRooms();
                View.showLoading(false);
                View.showRoomListModal(rooms, true);
            },

            confirmDeleteRoom(roomId) {
                View.showDeleteRoomModal(roomId, () => {
                    Service.deleteRoom(roomId)
                        .then(() => {
                            View.showMessageModal("åˆ é™¤æˆåŠŸ", "æˆ¿é—´ " + roomId + " å·²åˆ é™¤", () => {
                                this.closeModal();
                                setTimeout(() => this.showCleanRoomList(), 200);
                            });
                        })
                        .catch(e => View.showMessageModal("åˆ é™¤å¤±è´¥", "åˆ é™¤å¤±è´¥ï¼š" + e.message, this.closeModal));
                });
            },

            menuUsage() {
                this.toggleMenu();
                View.showUsageModal();
            },

            menuAbout() {
                this.toggleMenu();
                View.showAboutModal();
            },

            closeModal() {
                View.closeModal();
            }
        };

        // å°† App æŒ‚è½½åˆ° window ä»¥ä¾¿ onclick è°ƒç”¨
        window.App = App;
        
        // å…¼å®¹ Logic ä»¥ä¾¿æ¨¡æ¿ä¸­è°ƒç”¨ (å¦‚æœæœ‰)
        // å®é™…ä¸Šæ¨¡æ¿ä¸­è°ƒç”¨çš„æ˜¯ App çš„æ–¹æ³•æˆ–è€… Logic çš„è®¡ç®—æ–¹æ³•ã€‚
        // åœ¨ View.renderSessionRow ä¸­ç”¨åˆ°äº† Logic.calculateSessionTotal
        // å› ä¸ºæ¨¡æ¿å­—ç¬¦ä¸²æ˜¯åœ¨ View å†…éƒ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è®¿é—® Logicã€‚
        // åªæœ‰ onclick é‡Œçš„å­—ç¬¦ä¸²éœ€è¦å…¨å±€è®¿é—®ã€‚
        
        // å¯åŠ¨åº”ç”¨
        App.init();

    </script>
</body>

</html>