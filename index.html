<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç­” - å››äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        /* ============================================================
         * å…¨å±€æ ·å¼å®šä¹‰
         * - overflow-y: scroll å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼Œé˜²æ­¢å†…å®¹å˜åŒ–å¯¼è‡´çš„å¸ƒå±€æŠ–åŠ¨
         * - zebra-stripe æ–‘é©¬çº¹æ ·å¼ï¼Œç”¨äºè¡¨æ ¼å¥‡å¶è¡Œäº¤æ›¿èƒŒæ™¯è‰²
         * - modal-overlay æ¨¡æ€æ¡†é®ç½©å±‚åŠé€æ˜èƒŒæ™¯
         * - active-session å½“å‰æ¿€æ´»åœºæ¬¡çš„å·¦ä¾§è“è‰²è¾¹æ¡†æ ‡è¯†
         * ============================================================ */
        html {
            overflow-y: scroll;
        }
        .zebra-stripe:nth-child(odd) {
            background-color: #f9fafb;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .active-session {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- é¡¶éƒ¨åŠ è½½çŠ¶æ€æ¡ï¼šåœ¨è¿æ¥Firebaseæ—¶æ˜¾ç¤º -->
    <div id="loadingStatus" class="fixed top-0 left-0 w-full bg-blue-500 text-white text-xs py-1 text-center hidden">
        æ­£åœ¨è¿æ¥...
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ï¼šé™åˆ¶æœ€å¤§å®½åº¦ï¼Œå±…ä¸­æ˜¾ç¤º -->
    <div id="app" class="max-w-md mx-auto p-4 pb-20">
        <div id="view-container"></div>
    </div>

    <!-- é€šç”¨æ¨¡æ€æ¡†ï¼šæ‰€æœ‰å¼¹çª—å¤ç”¨æ­¤DOMç»“æ„ -->
    <div id="modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-xl">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">æç¤º</h3>
            <div id="modalBody" class="mb-6"></div>
            <div id="modalFooter" class="flex justify-end space-x-3">
                <button id="modalCancelBtn" onclick="App.closeModal()" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-500 text-white rounded">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ============================================================================
         * æ‰“ç­” - å››äººè®°åˆ†åº”ç”¨
         * ============================================================================
         * 
         * æ¶æ„è®¾è®¡ï¼ˆæ¨¡å—åŒ–å•æ–‡ä»¶ç»“æ„ï¼‰ï¼š
         * 
         * 1. CONFIG   - é™æ€é…ç½®ï¼šFirebaseè¿æ¥å‚æ•°ã€æ¸¸æˆè§„åˆ™å¸¸é‡
         * 2. Utils    - çº¯å·¥å…·å‡½æ•°ï¼šæ— çŠ¶æ€çš„å­—ç¬¦ä¸²å¤„ç†ã€æ—¶é—´æ ¼å¼åŒ–
         * 3. State    - åº”ç”¨çŠ¶æ€ï¼šç®¡ç†å½“å‰è§†å›¾ã€æˆ¿é—´æ•°æ®ã€UIçŠ¶æ€
         * 4. Logic    - ä¸šåŠ¡é€»è¾‘ï¼šåˆ†æ•°è®¡ç®—ã€æ¸¸æˆè§„åˆ™åˆ¤æ–­ï¼ˆçº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼‰
         * 5. Service  - æ•°æ®æœåŠ¡ï¼šFirebase CRUDæ“ä½œã€æœ¬åœ°ç¼“å­˜ç®¡ç†
         * 6. View     - è§†å›¾æ¸²æŸ“ï¼šHTMLæ¨¡æ¿ç”Ÿæˆã€DOMæ“ä½œã€æ¨¡æ€æ¡†ç®¡ç†
         * 7. App      - åº”ç”¨æ§åˆ¶å™¨ï¼šåè°ƒå„æ¨¡å—ã€å¤„ç†ç”¨æˆ·äº¤äº’
         * 
         * æ•°æ®æµå‘ï¼šç”¨æˆ·æ“ä½œ â†’ Appå¤„ç† â†’ Serviceæ›´æ–°æ•°æ® â†’ FirebaseåŒæ­¥ â†’ Stateæ›´æ–° â†’ Viewé‡æ¸²æŸ“
         * 
         * ============================================================================
         */

        // ============================================================
        // CONFIG: åº”ç”¨é…ç½®ä¸å¸¸é‡
        // é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹ï¼Œä¾¿äºç»´æŠ¤å’Œä¿®æ”¹
        // ============================================================
        const CONFIG = {
            // Firebase å®æ—¶æ•°æ®åº“é…ç½®
            FIREBASE: {
                apiKey: "AIzaSyAE2JJQ2w_fLcwl0tlF9qcwRCNes9oICsY",
                authDomain: "calculator-f4869.firebaseapp.com",
                databaseURL: "https://calculator-f4869-default-rtdb.firebaseio.com",
                projectId: "calculator-f4869",
                storageBucket: "calculator-f4869.firebasestorage.app",
                messagingSenderId: "657645216794",
                appId: "1:657645216794:web:1e2092b1fce925b6b09da3",
                measurementId: "G-TM8246NSRV"
            },
            // æ¸¸æˆè§„åˆ™é…ç½®
            GAME: {
                PLAYER_COUNT: 4,           // ç©å®¶äººæ•°
                WIN_SCORE: 100,            // è·èƒœæ‰€éœ€åˆ†æ•°
                UNIT_SCORE_DEFAULT: 0.3    // é»˜è®¤æ¯åˆ†é‡‘é¢
            },
            // æœ¬åœ°å­˜å‚¨é”®åå‰ç¼€
            STORAGE_KEYS: {
                ROOM_CACHE_PREFIX: 'room_cache_'
            }
        };

        // ============================================================
        // Utils: é€šç”¨å·¥å…·å‡½æ•°
        // æ— çŠ¶æ€çš„çº¯å‡½æ•°ï¼Œä¸ä¾èµ–åº”ç”¨çŠ¶æ€
        // ============================================================
        const Utils = {
            /**
             * è§£æç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²ä¸ºåˆ†éš”æ•°ç»„
             * æ”¯æŒç©ºæ ¼ã€ä¸­æ–‡é€—å·ã€è‹±æ–‡é€—å·ä½œä¸ºåˆ†éš”ç¬¦
             * @param {string} str - ç”¨æˆ·è¾“å…¥çš„åŸå§‹å­—ç¬¦ä¸²
             * @returns {string[]} - è¿‡æ»¤ç©ºç™½åçš„å­—ç¬¦ä¸²æ•°ç»„
             */
            parseInput(str) {
                return str.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
            },

            /**
             * å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸º HH:mm æ ¼å¼
             * ç”¨äºæ˜¾ç¤ºæ¯å±€è®°åˆ†çš„æ—¶é—´
             * @param {number} timestamp - æ¯«ç§’çº§æ—¶é—´æˆ³
             * @returns {string} - HH:mm æ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ— æ•ˆè¾“å…¥è¿”å›ç©ºä¸²
             */
            formatTime(timestamp) {
                if (!timestamp) return "";
                const date = new Date(timestamp);
                return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            },

            /**
             * è®¡ç®—å¹¶æ ¼å¼åŒ–æ¸¸æˆæŒç»­æ—¶é—´
             * ç”¨äºåœ¨ç»“ç®—é¡µé¢æ˜¾ç¤ºæ´»åŠ¨æ€»æ—¶é•¿
             * @param {number} start - å¼€å§‹æ—¶é—´æˆ³
             * @param {number} end - ç»“æŸæ—¶é—´æˆ³
             * @returns {string} - "Xå°æ—¶Yåˆ†é’Ÿ" æ ¼å¼ï¼Œæ— æ•ˆè¾“å…¥è¿”å›"æœªçŸ¥"
             */
            formatDuration(start, end) {
                if (!start || !end) return "æœªçŸ¥";
                const diff = end - start;
                if (diff < 0) return "æœªçŸ¥";
                return `${Math.floor(diff / 3600000)}å°æ—¶${Math.floor((diff % 3600000) / 60000)}åˆ†é’Ÿ`;
            }
        };

        // ============================================================
        // State: åº”ç”¨çŠ¶æ€ç®¡ç†
        // é›†ä¸­ç®¡ç†æ‰€æœ‰è¿è¡Œæ—¶çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
        // ============================================================
        const State = {
            view: 'home',                    // å½“å‰è§†å›¾: home|create|join|setup|room|calculate
            roomId: null,                    // å½“å‰æˆ¿é—´ID
            roomData: null,                  // æˆ¿é—´å®Œæ•´æ•°æ®ï¼ˆä»FirebaseåŒæ­¥ï¼‰
            expandedSessions: new Set(),     // å·²å±•å¼€çš„åœºæ¬¡IDé›†åˆï¼ˆç”¨äºæŠ˜å /å±•å¼€åŠŸèƒ½ï¼‰
            showMenu: false,                 // é¦–é¡µèœå•æ˜¯å¦æ˜¾ç¤º

            /** é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼ˆé€€å‡ºæˆ¿é—´æ—¶è°ƒç”¨ï¼‰ */
            reset() {
                this.roomId = null;
                this.roomData = null;
                this.expandedSessions.clear();
                this.showMenu = false;
            }
        };

        // ============================================================
        // Logic: ä¸šåŠ¡é€»è¾‘å±‚
        // çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼Œä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€
        // æ‰€æœ‰åˆ†æ•°è®¡ç®—å’Œè§„åˆ™åˆ¤æ–­éƒ½åœ¨è¿™é‡Œ
        // ============================================================
        const Logic = {
            /** ç©å®¶ç´¢å¼•æ•°ç»„ï¼Œé¿å…ä»£ç ä¸­é‡å¤ [0,1,2,3] */
            PLAYER_INDICES: [0, 1, 2, 3],

            /**
             * è®¡ç®—å•ä¸ªåœºæ¬¡ä¸­æŸç©å®¶çš„æ€»å¾—åˆ†
             * @param {Object} session - åœºæ¬¡æ•°æ®å¯¹è±¡
             * @param {number} playerIdx - ç©å®¶ç´¢å¼•(0-3)
             * @returns {number} - è¯¥åœºæ¬¡è¯¥ç©å®¶çš„æ€»åˆ†æ•°
             */
            calculateSessionTotal(session, playerIdx) {
                if (!session?.rounds) return 0;
                return session.rounds.reduce((sum, r) => sum + ((r.scores?.[playerIdx]) || 0), 0);
            },

            /**
             * è®¡ç®—æ‰€æœ‰åœºæ¬¡ä¸­æŸç©å®¶çš„æ€»å¾—åˆ†
             * @param {Object} roomData - å®Œæ•´æˆ¿é—´æ•°æ®
             * @param {number} playerIdx - ç©å®¶ç´¢å¼•(0-3)
             * @returns {number} - æ‰€æœ‰åœºæ¬¡çš„ç´¯è®¡æ€»åˆ†æ•°
             */
            calculateTotal(roomData, playerIdx) {
                if (!roomData?.sessions) return 0;
                return roomData.sessions.reduce((sum, s) => sum + this.calculateSessionTotal(s, playerIdx), 0);
            },

            /**
             * æ£€æŸ¥æŸåœºæ¬¡æ˜¯å¦å·²ç»“æŸï¼ˆä»»ä¸€ç©å®¶åˆ†æ•°è¾¾åˆ°100åˆ†ï¼‰
             * åªæœ‰å½“æœ€åä¸€å±€å®Œæˆï¼ˆ4äººåˆ†æ•°éƒ½å·²å¡«å†™ï¼‰æ—¶æ‰åˆ¤æ–­
             * @param {Object} session - åœºæ¬¡æ•°æ®
             * @returns {boolean} - æ˜¯å¦å·²ç»“æŸ
             */
            isGameOver(session) {
                if (!session?.rounds?.length) return false;
                const lastRound = session.rounds[session.rounds.length - 1];
                // æœ€åä¸€å±€æœªå®Œæˆæ—¶ä¸åˆ¤æ–­ç»“æŸ
                if (this.isRoundPartial(lastRound)) return false;
                // è®¡ç®—å„ç©å®¶æ€»åˆ†ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰äººè¾¾åˆ°è·èƒœåˆ†æ•°
                const totals = this.PLAYER_INDICES.map(i => this.calculateSessionTotal(session, i));
                return totals.some(t => t >= CONFIG.GAME.WIN_SCORE);
            },

            /**
             * æ£€æŸ¥æŸå±€æ˜¯å¦ä¸ºæœªå®ŒæˆçŠ¶æ€ï¼ˆæœ‰äººåˆ†æ•°æœªå¡«å†™ï¼‰
             * Firebaseå¯èƒ½å°†nullå­˜å‚¨ä¸ºundefinedæˆ–ç¨€ç–æ•°ç»„
             * @param {Object} round - å±€æ•°æ®
             * @returns {boolean} - æ˜¯å¦ä¸ºéƒ¨åˆ†å®ŒæˆçŠ¶æ€
             */
            isRoundPartial(round) {
                if (!round?.scores) return true;
                return this.PLAYER_INDICES.some(i => round.scores[i] === null || round.scores[i] === undefined);
            },

            /**
             * è®¡ç®—æœ€ç»ˆè¾“èµ¢é‡‘é¢
             * å…¬å¼: (4äººæ€»åˆ† - ä¸ªäººæ€»åˆ† Ã— 4) Ã— æ¯åˆ†é‡‘é¢
             * åŸç†: ä¸ªäººæ€»åˆ†ä¸å¹³å‡åˆ†çš„å·®å¼‚ï¼Œä¹˜ä»¥æ¯åˆ†é‡‘é¢
             * @param {Object} roomData - å®Œæ•´æˆ¿é—´æ•°æ®
             * @returns {Array<{name:string, val:number}>} - å„ç©å®¶è¾“èµ¢é‡‘é¢æ•°ç»„
             */
            calculateResults(roomData) {
                const totalGroupScore = roomData.players.reduce((sum, _, i) => sum + this.calculateTotal(roomData, i), 0);
                return roomData.players.map((name, i) => {
                    const personalTotal = this.calculateTotal(roomData, i);
                    const winLoss = (totalGroupScore - personalTotal * 4) * roomData.unitScore;
                    return { name, val: Number(winLoss.toFixed(1)) };
                });
            },

            /**
             * è®¡ç®—åœºæ¬¡ä¸­æ¯å±€çš„ç´¯è®¡åˆ†å†å²ï¼ˆç”¨äºæ˜ç»†æ˜¾ç¤ºï¼‰
             * è¿”å›æ¯å±€è®°å½•ï¼šå±€ç´¢å¼•ã€æœ¬å±€åˆ†æ•°ã€å±€å‰ç´¯è®¡åˆ†ã€æ—¶é—´æˆ³
             * @param {Object} session - åœºæ¬¡æ•°æ®
             * @returns {Array} - å†å²è®°å½•æ•°ç»„
             */
            calculateRoundHistory(session) {
                const rounds = session.rounds || [];
                const totals = [0, 0, 0, 0]; // ç´¯è®¡åˆ†
                return rounds.map((r, rIdx) => {
                    const scores = this.PLAYER_INDICES.map(i => r.scores?.[i]);
                    const before = [...totals];
                    scores.forEach((s, i) => totals[i] += (s || 0));
                    return { roundIndex: rIdx, scores, totalsBefore: before, timestamp: r.timestamp };
                });
            }
        };

        // ============================================================
        // Service: æ•°æ®æœåŠ¡å±‚
        // å°è£…æ‰€æœ‰Firebaseæ“ä½œå’Œæœ¬åœ°ç¼“å­˜é€»è¾‘
        // ============================================================
        const Service = {
            db: null,

            /** åˆå§‹åŒ–Firebaseè¿æ¥ */
            init() {
                if (!firebase.apps.length) firebase.initializeApp(CONFIG.FIREBASE);
                this.db = firebase.database();
            },

            /** è·å–æˆ¿é—´æ•°æ®å¼•ç”¨è·¯å¾„ */
            roomRef(id) {
                return this.db.ref('rooms/' + id);
            },

            /** æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨ */
            async checkRoomExists(id) {
                return (await this.roomRef(id).once('value')).exists();
            },

            /**
             * è®¢é˜…æˆ¿é—´æ•°æ®å˜åŒ–
             * åŒæ—¶æ›´æ–°æœ¬åœ°ç¼“å­˜ä»¥æ”¯æŒç¦»çº¿å¿«é€ŸåŠ è½½
             * @param {string} id - æˆ¿é—´ID
             * @param {Function} callback - æ•°æ®å˜åŒ–å›è°ƒ
             */
            subscribeRoom(id, callback) {
                this.roomRef(id).on('value', (snap) => {
                    const val = snap.val();
                    if (val) localStorage.setItem(CONFIG.STORAGE_KEYS.ROOM_CACHE_PREFIX + id, JSON.stringify(val));
                    callback(val);
                });
            },

            /** å–æ¶ˆæˆ¿é—´æ•°æ®è®¢é˜… */
            unsubscribeRoom(id) {
                if (id) this.roomRef(id).off();
            },

            /** ä»æœ¬åœ°ç¼“å­˜è¯»å–æˆ¿é—´æ•°æ® */
            loadFromCache(id) {
                try {
                    const cached = localStorage.getItem(CONFIG.STORAGE_KEYS.ROOM_CACHE_PREFIX + id);
                    return cached ? JSON.parse(cached) : null;
                } catch (e) {
                    console.error("Cache load error", e);
                    return null;
                }
            },

            /** åˆ›å»ºæ–°æˆ¿é—´ */
            createRoom(id, players) {
                return this.roomRef(id).update({
                    players,
                    unitScore: CONFIG.GAME.UNIT_SCORE_DEFAULT,
                    currentSessionId: 1,
                    sessions: [{ id: 1, rounds: [] }],
                    createdAt: Date.now()
                });
            },

            /** åˆ é™¤æˆ¿é—´ */
            deleteRoom(id) {
                return this.roomRef(id).remove();
            },

            /** è·å–æ‰€æœ‰æˆ¿é—´åˆ—è¡¨ */
            async getAllRooms() {
                return (await this.db.ref('rooms').once('value')).val();
            }
        };

        // ============================================================
        // View: è§†å›¾æ¸²æŸ“å±‚
        // è´Ÿè´£HTMLæ¨¡æ¿ç”Ÿæˆã€DOMæ“ä½œå’Œæ¨¡æ€æ¡†ç®¡ç†
        // ============================================================
        const View = {
            container: document.getElementById('view-container'),
            loading: document.getElementById('loadingStatus'),
            modalCallback: null,  // æ¨¡æ€æ¡†ç¡®è®¤å›è°ƒ

            /** åˆå§‹åŒ–è§†å›¾ï¼šç»‘å®šæ¨¡æ€æ¡†ç¡®è®¤æŒ‰é’®äº‹ä»¶ */
            init() {
                document.getElementById('modalConfirmBtn').onclick = () => this.modalCallback?.();
            },

            /** åˆ‡æ¢åŠ è½½çŠ¶æ€æ¡æ˜¾ç¤º */
            showLoading(show) {
                this.loading.classList.toggle('hidden', !show);
            },

            /** ä¸»æ¸²æŸ“å…¥å£ï¼šæ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©å¯¹åº”æ¸²æŸ“æ–¹æ³• */
            render() {
                const renderMap = {
                    home: this.renderHome,
                    create: this.renderEntry,
                    join: this.renderEntry,
                    setup: this.renderSetup,
                    room: this.renderRoom,
                    calculate: this.renderCalculate
                };
                renderMap[State.view]?.call(this);
            },

            // ==================== é¡µé¢æ¸²æŸ“æ–¹æ³• ====================

            /** æ¸²æŸ“é¦–é¡µ */
            renderHome() {
                this.container.innerHTML = `
                    <div class="flex flex-col min-h-[80vh]">
                        <div class="flex justify-end pt-2 relative">
                            <button onclick="App.toggleMenu()" class="p-2 text-gray-600 hover:text-gray-900 focus:outline-none transition-colors rounded-full hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                            </button>
                            ${State.showMenu ? this.renderMenu() : ''}
                        </div>
                        <div class="flex-1 flex flex-col justify-center pb-20">
                            <h1 class="text-5xl font-black text-center mb-16 tracking-widest text-blue-600 drop-shadow-sm">æ‰“ç­”</h1>
                            <div class="flex flex-col space-y-6 px-8">
                                <button onclick="App.navigate('create')" class="bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">â•</span> åˆ›å»ºæˆ¿é—´
                                </button>
                                <button onclick="App.navigate('join')" class="bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 py-5 rounded-2xl font-bold text-xl shadow-md active:scale-95 transition transform duration-200 flex items-center justify-center">
                                    <span class="mr-2">ğŸ”</span> åŠ å…¥æˆ¿é—´
                                </button>
                            </div>
                        </div>
                    </div>`;
            },

            /** æ¸²æŸ“å³ä¸Šè§’èœå• */
            renderMenu() {
                const menuItems = [
                    { icon: 'ğŸ ', text: 'æŸ¥çœ‹ç°æœ‰æˆ¿é—´', action: 'App.menuViewRooms()', hover: 'blue' },
                    { icon: 'ğŸ—‘ï¸', text: 'æ¸…ç†æˆ¿é—´', action: 'App.menuCleanRoom()', hover: 'red' },
                    { icon: 'ğŸ“–', text: 'ä½¿ç”¨æ–¹æ³•', action: 'App.menuUsage()', hover: 'green' },
                    { icon: 'â„¹ï¸', text: 'å…³äº', action: 'App.menuAbout()', hover: 'purple' }
                ];
                return `
                    <div class="absolute right-0 top-12 w-48 bg-white border border-gray-200 rounded-lg shadow-2xl z-50 text-base overflow-hidden">
                        ${menuItems.map((item, idx) => `
                            <button onclick="${item.action}" class="block w-full text-left px-4 py-3 hover:bg-${item.hover}-50 text-gray-700 hover:text-${item.hover}-600 ${idx < 3 ? 'border-b border-gray-100' : ''} transition-colors flex items-center">
                                <span class="mr-2">${item.icon}</span> ${item.text}
                            </button>
                        `).join('')}
                    </div>`;
            },

            /** æ¸²æŸ“åˆ›å»º/åŠ å…¥æˆ¿é—´é¡µé¢ */
            renderEntry() {
                const isCreate = State.view === 'create';
                this.container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-2xl font-bold mb-6 text-center">${isCreate ? 'åˆ›å»º' : 'åŠ å…¥'}æˆ¿é—´</h2>
                        <input type="number" id="roomNumInput" placeholder="è¾“å…¥æˆ¿é—´å·(æ•°å­—)" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 text-center text-xl focus:border-blue-500 outline-none">
                        <button onclick="App.handleJoinRoom(document.getElementById('roomNumInput').value, ${isCreate})" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">ç¡®è®¤</button>
                        <button onclick="App.navigate('home')" class="w-full text-gray-500 mt-4 text-center">è¿”å›</button>
                    </div>`;
            },

            /** æ¸²æŸ“æ–°æˆ¿é—´è®¾ç½®é¡µé¢ */
            renderSetup() {
                this.container.innerHTML = `
                    <div class="flex flex-col justify-center min-h-[80vh]">
                        <h2 class="text-xl font-bold mb-4">æ–°æˆ¿é—´è®¾ç½®</h2>
                        <p class="text-gray-600 mb-2 text-sm">è¯·è¾“å…¥4ä¸ªé“ä»”åå­—ï¼ˆç©ºæ ¼æˆ–é€—å·åˆ†éš”ï¼‰</p>
                        <input type="text" id="playerNames" placeholder="å°ç‹ å°æ é˜¿å¼º å¤§å£®" class="w-full border-2 border-gray-200 rounded-lg p-4 mb-4 outline-none focus:border-blue-500">
                        <button onclick="App.submitSetup(document.getElementById('playerNames').value)" class="w-full bg-blue-500 text-white py-4 rounded-lg font-bold">è¿›å…¥æˆ¿é—´</button>
                    </div>`;
            },

            /** æ¸²æŸ“æˆ¿é—´ä¸»é¡µé¢ï¼ˆæ ¸å¿ƒé¡µé¢ï¼‰ */
            renderRoom() {
                const d = State.roomData;
                const players = d.players;
                const sessions = [...d.sessions].reverse(); // æœ€æ–°åœºæ¬¡æ˜¾ç¤ºåœ¨ä¸Šæ–¹

                this.container.innerHTML = `
                    <div class="relative flex justify-center items-center mb-6">
                        <h1 class="text-3xl font-black text-blue-600">æ‰“ç­”</h1>
                        <button onclick="App.exitRoom()" class="absolute right-0 text-red-500 font-medium text-lg border border-red-200 px-3 py-1 rounded">é€€å‡ºæˆ¿é—´</button>
                    </div>
                    <div id="pullToRefreshIndicator" class="hidden text-center text-gray-500 text-sm py-2">ä¸‹æ‹‰åˆ·æ–°...</div>
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-bold">æ¯åˆ†é‡‘é¢:</span>
                                <span class="font-bold text-lg mx-2">${d.unitScore}</span>
                                <button onclick="App.openUnitScoreModal()" class="text-blue-500 text-lg font-bold">ä¿®æ”¹</button>
                            </div>
                            <button onclick="App.refreshRoom()" class="bg-green-500 text-white text-base px-3 py-1 rounded shadow">åˆ·æ–°æ•°æ®</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 text-center text-sm">
                        <table class="w-full border-collapse table-fixed">
                            <thead>
                                <tr class="bg-gray-800 text-white">
                                    <th class="w-1/6 py-3 px-1 font-medium text-base text-center">åœºæ¬¡</th>
                                    ${players.map((p, i) => `<th class="w-1/6 py-3 px-1 font-medium text-lg text-center cursor-pointer hover:text-blue-300" onclick="App.headerPlayerClick(${i})">${p}</th>`).join('')}
                                    <th class="w-1/6 py-3 px-1">
                                        <button onclick="App.startNewSession()" class="text-green-600 font-bold text-lg cursor-pointer hover:text-green-800">åŠ åœº</button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-blue-50 font-bold border-b-2 border-blue-100 text-base">
                                    <td class="py-4 text-center">å…¨éƒ¨</td>
                                    ${players.map((_, i) => `<td class="text-center">${Logic.calculateTotal(d, i)}</td>`).join('')}
                                    <td class="text-blue-600 cursor-pointer font-bold text-lg" onclick="App.navigate('calculate')">è®¡ç®—</td>
                                </tr>
                                ${sessions.map(s => this.renderSessionRow(s, players, d.currentSessionId)).join('')}
                            </tbody>
                        </table>
                    </div>`;
                this.setupPullToRefresh();
            },

            /** æ¸²æŸ“å•ä¸ªåœºæ¬¡è¡Œï¼ˆåŒ…å«æ±‡æ€»è¡Œå’Œå±•å¼€åçš„æ˜ç»†è¡Œï¼‰ */
            renderSessionRow(session, players, currentId) {
                const isCurrent = session.id === currentId;
                const isExpanded = State.expandedSessions.has(session.id);
                const sessionIdx = State.roomData.sessions.findIndex(s => s.id === session.id);
                
                // æ±‡æ€»è¡Œ
                const rowClass = isCurrent ? 'bg-yellow-50 active-session border-b border-yellow-100' : 'zebra-stripe';
                let html = `
                    <tr class="${rowClass} text-base">
                        <td class="py-4 font-bold text-center">${session.id}</td>
                        ${players.map((_, i) => `<td class="text-center">${Logic.calculateSessionTotal(session, i)}</td>`).join('')}
                        <td class="text-blue-500 font-medium">
                            <button onclick="App.toggleSession(${session.id})" class="font-bold text-base">${isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}</button>
                        </td>
                    </tr>`;

                // å±•å¼€åçš„æ˜ç»†è¡Œ
                if (isExpanded) {
                    // å½“å‰åœºæ¬¡æ˜¾ç¤º"æœ¬å±€"è¡Œï¼ˆç”¨äºå¿«é€Ÿè®°åˆ†ï¼‰
                    if (isCurrent) {
                        html += this.renderCurrentRoundRow(session, players, sessionIdx);
                    }
                    // å†å²å±€æ˜ç»†
                    html += this.renderHistoryRows(session, players, isCurrent, sessionIdx);
                }
                return html;
            },

            /** æ¸²æŸ“"æœ¬å±€"è¡Œï¼ˆå½“å‰åœºæ¬¡çš„å¿«é€Ÿè®°åˆ†å…¥å£ï¼‰ */
            renderCurrentRoundRow(session, players, sessionIdx) {
                const rounds = session.rounds || [];
                const lastRound = rounds[rounds.length - 1];
                const isPartial = Logic.isRoundPartial(lastRound);

                return `<tr class="text-sm text-gray-500 bg-white font-bold">
                    <td class="py-2 text-center">æœ¬å±€</td>
                    ${players.map((_, i) => {
                        const total = Logic.calculateSessionTotal(session, i);
                        let content = '', btnClass = 'text-blue-600 hover:text-blue-800';
                        
                        if (isPartial && lastRound?.scores) {
                            const s = lastRound.scores[i];
                            if (s !== null && s !== undefined) {
                                btnClass = 'text-blue-400 hover:text-blue-600';
                                content = this.renderScoreDisplay(total - s, s);
                            }
                        } else if (!isPartial) {
                            content = this.renderScoreDisplay(total, '');
                        }
                        
                        return `<td class="text-left pl-2">
                            <button onclick="App.openAddSingleScoreModal(${sessionIdx}, ${i})" class="${btnClass} font-bold px-1 py-1 rounded w-full text-sm whitespace-nowrap block">${content}</button>
                        </td>`;
                    }).join('')}
                    <td class="pl-0"><button class="text-base text-blue-500 font-bold whitespace-nowrap" onclick="App.openScoreModal(${sessionIdx})">è®°åˆ†</button></td>
                </tr>`;
            },

            /** æ¸²æŸ“å†å²å±€æ˜ç»†è¡Œ */
            renderHistoryRows(session, players, isCurrent, sessionIdx) {
                const history = Logic.calculateRoundHistory(session);
                return history.reverse().map(rData => {
                    const timeStr = Utils.formatTime(rData.timestamp);
                    const actionCol = isCurrent 
                        ? `<div class="flex flex-col items-center">
                            <button class="text-base text-blue-400 font-bold mb-1 whitespace-nowrap" onclick="App.openScoreModal(${sessionIdx}, ${rData.roundIndex})">ä¿®æ”¹</button>
                            <span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>
                           </div>`
                        : `<span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>`;

                    return `<tr class="text-sm text-gray-500 bg-white">
                        <td class="py-2 text-center">å±€ ${rData.roundIndex + 1}</td>
                        ${rData.scores.map((s, pi) => `<td class="text-left pl-2">${this.renderScoreCell(s, pi, rData.totalsBefore[pi], isCurrent, sessionIdx, rData.roundIndex)}</td>`).join('')}
                        <td class="pl-0">${actionCol}</td>
                    </tr>`;
                }).join('');
            },

            /** æ¸²æŸ“åˆ†æ•°å•å…ƒæ ¼ï¼ˆå¯ç‚¹å‡»ä¿®æ”¹ï¼‰ */
            renderScoreCell(score, playerIdx, beforeTotal, isCurrent, sessionIdx, roundIndex) {
                const isScoreEmpty = score === null || score === undefined;
                const content = this.renderScoreDisplay(beforeTotal, isScoreEmpty ? '' : score);
                
                if (!isCurrent) return `<div class="px-1 font-mono">${content}</div>`;
                
                const btnClass = isScoreEmpty ? 'text-blue-600 hover:text-blue-800' : 'text-blue-400 hover:text-blue-600';
                return `<button onclick="App.openSingleScoreModal(${sessionIdx}, ${roundIndex}, ${playerIdx})" class="${btnClass} font-bold px-1 py-1 rounded w-full text-sm whitespace-nowrap block">${content}</button>`;
            },

            /** ç”Ÿæˆåˆ†æ•°æ˜¾ç¤ºHTMLï¼ˆç´¯è®¡åˆ† - æœ¬å±€åˆ† æ ¼å¼ï¼‰ */
            renderScoreDisplay(leftVal, rightVal) {
                return `<div class="flex items-center justify-start w-full font-mono">
                    <div class="w-[3ch] text-right">${leftVal}</div>
                    <div class="px-1 text-center">-</div>
                    <div class="w-[2ch] text-left">${rightVal}</div>
                </div>`;
            },

            /** æ¸²æŸ“ç»“ç®—é¡µé¢ */
            renderCalculate() {
                const d = State.roomData;
                const results = Logic.calculateResults(d);
                const durationStr = Utils.formatDuration(d.createdAt, d.lastScoreTime);

                this.container.innerHTML = `
                    <div class="text-center py-10 flex flex-col min-h-[80vh] justify-center">
                        <h2 class="text-xl font-bold mb-8">è¿™4ä½é“ä»”çš„è¾“èµ¢æƒ…å†µå¦‚ä¸‹</h2>
                        <div class="space-y-6 mb-8">
                            ${results.map(r => `
                                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm px-8">
                                    <span class="text-base font-medium">${r.name}</span>
                                    <span class="text-xl font-black ${r.val > 0 ? 'text-red-500' : r.val < 0 ? 'text-green-600' : 'text-gray-400'}">
                                        ${r.val > 0 ? '+' : ''}${r.val}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mb-12">
                             <span class="inline-block bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm font-medium">æ´»åŠ¨æ—¶é•¿ï¼š${durationStr}</span>
                        </div>
                        <button onclick="App.navigate('room')" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg">è¿”å›æˆ¿é—´</button>
                    </div>`;
            },

            // ==================== æ¨¡æ€æ¡†æ–¹æ³• ====================

            /**
             * é€šç”¨æ¨¡æ€æ¡†æ˜¾ç¤ºæ–¹æ³•
             * æ‰€æœ‰ç‰¹å®šæ¨¡æ€æ¡†éƒ½é€šè¿‡æ­¤æ–¹æ³•å®ç°
             * @param {Object} options - é…ç½®é€‰é¡¹
             */
            showModal({ title, body, onConfirm, hasInput = false, inputDefault = '', confirmText = 'ç¡®è®¤', cancelText = 'å–æ¶ˆ', inputMode = 'text' }) {
                const titleEl = document.getElementById('modalTitle');
                const isTip = title === 'æç¤º';
                
                // æ ¹æ®æ˜¯å¦ä¸º"æç¤º"ç±»å‹è°ƒæ•´æ ‡é¢˜æ˜¾ç¤º
                isTip ? titleEl.classList.add('hidden') : (titleEl.innerText = title, titleEl.classList.remove('hidden'));
                
                // æ„å»ºæ¨¡æ€æ¡†å†…å®¹
                const bodyClass = isTip ? 'text-gray-900 font-bold mb-4 text-lg' : 'text-gray-600 mb-4';
                document.getElementById('modalBody').innerHTML = `
                    <div class="${bodyClass}">${body}</div>
                    ${hasInput ? `<input type="text" id="modalInput" value="${inputDefault}" inputmode="${inputMode}" class="w-full border p-3 rounded outline-none focus:border-blue-500" autofocus>` : ''}`;
                
                // é…ç½®ç¡®è®¤æŒ‰é’®
                const confirmBtn = document.getElementById('modalConfirmBtn');
                confirmText ? (confirmBtn.innerText = confirmText, confirmBtn.classList.remove('hidden')) : confirmBtn.classList.add('hidden');
                
                document.getElementById('modalCancelBtn').innerText = cancelText;
                document.getElementById('modal').classList.remove('hidden');
                document.getElementById('modalFooter').style.display = 'flex';
                
                this.modalCallback = onConfirm;
            },

            /** å…³é—­æ¨¡æ€æ¡† */
            closeModal() {
                document.getElementById('modal').classList.add('hidden');
                this.modalCallback = null;
            },

            /** æ˜¾ç¤ºè‡ªå®šä¹‰æŒ‰é’®çš„æ¨¡æ€æ¡† */
            showCustomModal({ title, body, buttons }) {
                this.showModal({ title, body, onConfirm: null });
                document.getElementById('modalFooter').style.display = 'none';
                
                // åŠ¨æ€ç»‘å®šæŒ‰é’®äº‹ä»¶
                setTimeout(() => buttons.forEach(({ id, handler }) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.onclick = handler;
                }), 0);
            },

            // ==================== ç‰¹å®šæ¨¡æ€æ¡†å¿«æ·æ–¹æ³• ====================

            /** è¾“å…¥æ¡†æ¨¡æ€æ¡† */
            showInputModal(title, body, defaultVal, onConfirm, inputMode = 'text') {
                this.showModal({ title, body, hasInput: true, inputDefault: defaultVal, onConfirm, inputMode });
            },

            /** æ¶ˆæ¯æç¤ºæ¨¡æ€æ¡† */
            showMessageModal(title, content, onConfirm) {
                this.showModal({ title, body: content, onConfirm });
            },

            /** ç¡®è®¤åˆ é™¤æˆ¿é—´æ¨¡æ€æ¡† */
            showDeleteRoomModal(roomId, onConfirm) {
                this.showModal({
                    title: 'ç¡®è®¤åˆ é™¤',
                    body: `ç¡®å®šè¦åˆ é™¤æˆ¿é—´ <span class="font-bold text-red-500">${roomId}</span> åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ<br><br><span class="text-xs text-gray-500">æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</span>`,
                    onConfirm
                });
            },

            /** æˆ¿é—´å·²å­˜åœ¨æ¨¡æ€æ¡†ï¼ˆæä¾›è¿›å…¥æˆ–é‡æ–°åˆ›å»ºé€‰é¡¹ï¼‰ */
            showRoomExistsModal(id, onEnter, onRecreate) {
                this.showCustomModal({
                    title: 'æˆ¿é—´å·²å­˜åœ¨',
                    body: `<p class="mb-4">æˆ¿é—´å· <strong>${id}</strong> å·²å­˜åœ¨ã€‚</p>
                           <p class="mb-4 text-sm text-gray-600">æ‚¨å¯ä»¥é€‰æ‹©ï¼š</p>
                           <div class="space-y-2">
                               <button id="modalRecreateBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">é‡æ–°åˆ›å»º (è¿”å›)</button>
                               <button id="modalEnterBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600">è¿›å…¥è¯¥æˆ¿é—´</button>
                           </div>`,
                    buttons: [
                        { id: 'modalRecreateBtn', handler: onRecreate },
                        { id: 'modalEnterBtn', handler: onEnter }
                    ]
                });
            },

            /** æ¸¸æˆç»“æŸæ¨¡æ€æ¡† */
            showGameOverModal(onBack, onNext) {
                this.showCustomModal({
                    title: 'æç¤º',
                    body: `<div class="text-center">
                        <p class="text-xl font-bold text-red-500 mb-4">æœ¬åœºå·²ç»“æŸ</p>
                        <div class="space-y-3">
                            <button id="modalBackBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">è¿”å›</button>
                            <button id="modalNextBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600">å¼€å¯ä¸‹ä¸€åœºæ¬¡</button>
                        </div>
                    </div>`,
                    buttons: [
                        { id: 'modalBackBtn', handler: onBack },
                        { id: 'modalNextBtn', handler: onNext }
                    ]
                });
            },

            /** æˆ¿é—´åˆ—è¡¨æ¨¡æ€æ¡† */
            showRoomListModal(rooms, isCleanMode) {
                const content = !rooms ? 'æš‚æ— æˆ¿é—´' : Object.keys(rooms).map(id => {
                    const r = rooms[id];
                    const players = r.players?.join('ï¼Œ') || 'ï¼ˆæœªè®¾ç½®ç©å®¶ï¼‰';
                    return isCleanMode 
                        ? `<div class="flex justify-between items-center mb-2 border-b pb-1">
                            <div class="flex-1"><strong>æˆ¿é—´å·ï¼š${id}</strong><br><span class="text-xs text-gray-500">${players}</span></div>
                            <button onclick="App.confirmDeleteRoom('${id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded ml-2 shadow-sm transition-colors">åˆ é™¤</button>
                           </div>`
                        : `<div class="mb-2 border-b pb-1"><strong>æˆ¿é—´å·ï¼š${id}</strong><br><span class="text-xs text-gray-500">${players}</span></div>`;
                }).join('');
                
                this.showModal({ title: isCleanMode ? 'æ¸…ç†æˆ¿é—´åˆ—è¡¨' : 'ç°æœ‰æˆ¿é—´', body: content, onConfirm: () => this.closeModal() });
            },

            /** ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† */
            showUsageModal() {
                this.showModal({
                    title: 'ä½¿ç”¨æ–¹æ³•',
                    body: `<div class="text-sm space-y-3 text-left">
                        <p><strong>1. å¦‚ä½•åˆ›å»ºæˆ¿é—´ï¼š</strong>ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>2. å¦‚ä½•åŠ å…¥æˆ¿é—´ï¼š</strong>ç‚¹å‡»"åŠ å…¥æˆ¿é—´"æŒ‰é’®ï¼Œè¾“å…¥æˆ¿é—´å·ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>3. å¦‚ä½•ä¿®æ”¹æ¯åˆ†é‡‘é¢ï¼š</strong>ç‚¹å‡»"æ¯åˆ†é‡‘é¢"åé¢çš„"ä¿®æ”¹"æŒ‰é’®ï¼Œè¾“å…¥æ–°çš„é‡‘é¢ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>4. å¦‚ä½•æ·»åŠ åœºæ¬¡ï¼š</strong>ç‚¹å‡»è¡¨æ ¼å¤´éƒ¨çš„"åŠ åœº"æŒ‰é’®ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>5. å¦‚ä½•æ·»åŠ æœ¬å±€è®°åˆ†ï¼š</strong>ç‚¹å‡»æœ€æ–°å±€çš„"è®°åˆ†"æŒ‰é’®ï¼ŒæŒ‰é¡ºåºè¾“å…¥ç©å®¶Aã€Bã€Cã€Dçš„å¾—åˆ†ï¼Œç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ã€‚</p>
                        <p><strong>6. å¦‚ä½•è®¡ç®—ç»“æœï¼š</strong>ç‚¹å‡»"è®¡ç®—"æŒ‰é’®ï¼Œå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºè®¡ç®—ç»“æœã€‚</p>
                        <p><strong>7. è®¡ç®—å…¬å¼ï¼š</strong><br>
                        ä¸ªäººè¾“èµ¢ = (4äººæ€»åˆ† - ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° Ã— 4) Ã— æ¯åˆ†é‡‘é¢<br>
                        <span class="text-xs text-gray-400">ä¸ªäººæ€»åœºæ¬¡åˆ†æ•° = ä¸ªäººåœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                        4äººæ€»åˆ† = æ‰€æœ‰ç©å®¶åœ¨æ‰€æœ‰åœºæ¬¡ä¸­çš„æ€»åˆ†æ•°<br>
                        æ¯åˆ†é‡‘é¢ = ç”¨æˆ·åœ¨è½¯ä»¶ä¸­è®¾ç½®çš„æ¯åˆ†é‡‘é¢</span></p>
                    </div>`,
                    onConfirm: () => this.closeModal()
                });
            },

            /** å…³äºæ¨¡æ€æ¡† */
            showAboutModal() {
                this.showModal({
                    title: 'å…³äº',
                    body: `<div class="text-left space-y-2">
                        <p><strong>è½¯ä»¶åç§°ï¼š</strong>æ‰“ç­”</p>
                        <p><strong>ä½œè€…ï¼š</strong>Kaishen</p>
                        <p><strong>è”ç³»ä½œè€…ï¼š</strong>å…ˆçœ‹"ä½¿ç”¨æ–¹æ³•"ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œå†è”ç³»ä½œè€…ã€‚</p>
                        <p><strong>è½¯ä»¶ç›®çš„ï¼š</strong>æä¾›ä¸€ä¸ªæ–¹ä¾¿çš„æ‰“ç­”è®°å½•å’Œè®°åˆ†è½¯ä»¶ã€‚</p>
                        <p class="mt-4 italic text-gray-500 text-center">"èµ¢é’±éæˆ‘æ„ï¼Œä½†æ„¿å‹é•¿å­˜ã€‚"</p>
                    </div>`,
                    onConfirm: () => this.closeModal()
                });
            },

            // ==================== ä¸‹æ‹‰åˆ·æ–° ====================

            /** è®¾ç½®ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ */
            setupPullToRefresh() {
                if (this._pullToRefreshSetup) return;
                this._pullToRefreshSetup = true;

                let touchStartY = 0;
                const threshold = 80;

                window.addEventListener('touchstart', e => {
                    if (window.scrollY === 0 && e.changedTouches?.length > 0) {
                        touchStartY = e.changedTouches[0].screenY;
                    }
                }, { passive: true });

                window.addEventListener('touchmove', e => {
                    const indicator = document.getElementById('pullToRefreshIndicator');
                    if (!indicator || window.scrollY !== 0 || touchStartY <= 0 || !e.changedTouches?.length) return;
                    if (e.changedTouches[0].screenY > touchStartY) indicator.classList.remove('hidden');
                }, { passive: true });

                window.addEventListener('touchend', e => {
                    const indicator = document.getElementById('pullToRefreshIndicator');
                    if (!indicator || window.scrollY !== 0 || touchStartY <= 0 || !e.changedTouches?.length) {
                        touchStartY = 0;
                        return;
                    }
                    
                    const touchEndY = e.changedTouches[0].screenY;
                    if (touchEndY - touchStartY > threshold) {
                        indicator.innerText = 'åˆ·æ–°ä¸­...';
                        App.refreshRoom();
                        setTimeout(() => {
                            const ind = document.getElementById('pullToRefreshIndicator');
                            if (ind) { ind.classList.add('hidden'); ind.innerText = 'ä¸‹æ‹‰åˆ·æ–°...'; }
                        }, 1000);
                    } else {
                        indicator.classList.add('hidden');
                    }
                    touchStartY = 0;
                }, { passive: true });
            }
        };

        // ============================================================
        // App: åº”ç”¨æ§åˆ¶å™¨
        // åè°ƒå„æ¨¡å—ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’
        // ============================================================
        const App = {
            /** åˆå§‹åŒ–åº”ç”¨ */
            init() {
                Service.init();
                View.init();
                this.navigate('home');
            },

            /** åˆ‡æ¢è§†å›¾ */
            navigate(view) {
                State.view = view;
                View.render();
            },

            /** åˆ‡æ¢èœå•æ˜¾ç¤ºçŠ¶æ€ */
            toggleMenu() {
                State.showMenu = !State.showMenu;
                View.render();
            },

            // ==================== æˆ¿é—´ç®¡ç† ====================

            /**
             * å¤„ç†åŠ å…¥æˆ¿é—´é€»è¾‘
             * @param {string} id - æˆ¿é—´å·
             * @param {boolean} isCreate - æ˜¯å¦ä¸ºåˆ›å»ºæ¨¡å¼
             */
            async handleJoinRoom(id, isCreate = false) {
                if (!/^\d+$/.test(id)) return alert('æˆ¿é—´å·å¿…é¡»æ˜¯æ•°å­—');
                View.showLoading(true);

                const exists = await Service.checkRoomExists(id);
                View.showLoading(false);

                if (isCreate && exists) {
                    View.showRoomExistsModal(id, () => this.enterRoom(id), () => View.closeModal());
                } else if (!isCreate && !exists) {
                    View.showMessageModal('æç¤º', 'æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æˆ¿é—´å·', () => View.closeModal());
                } else {
                    this.enterRoom(id);
                }
            },

            /** è¿›å…¥æˆ¿é—´ */
            enterRoom(id) {
                View.closeModal();
                State.roomId = id;

                // 1. ä¼˜å…ˆä»ç¼“å­˜åŠ è½½ï¼ˆå¿«é€Ÿå“åº”ï¼‰
                const cachedData = Service.loadFromCache(id);
                if (cachedData?.players) {
                    State.roomData = cachedData;
                    this.initExpandedSessions();
                    if (State.view !== 'calculate') {
                        State.view = 'room';
                        View.render();
                    }
                }

                // 2. å»ºç«‹å®æ—¶æ•°æ®è®¢é˜…
                Service.subscribeRoom(id, (val) => {
                    State.roomData = val;
                    View.showLoading(false);
                    
                    if (!val?.players) {
                        this.navigate('setup');
                    } else {
                        this.initExpandedSessions();
                        if (State.view === 'room') View.render();
                        else if (State.view !== 'calculate') this.navigate('room');
                    }
                });
            },

            /** åˆå§‹åŒ–å±•å¼€çŠ¶æ€ï¼šé»˜è®¤å±•å¼€æœ€æ–°åœºæ¬¡ */
            initExpandedSessions() {
                if (State.roomData.sessions?.length) {
                    State.expandedSessions.add(State.roomData.sessions[State.roomData.sessions.length - 1].id);
                }
            },

            /** é€€å‡ºæˆ¿é—´ */
            exitRoom() {
                Service.unsubscribeRoom(State.roomId);
                State.reset();
                this.navigate('home');
            },

            /** ç‚¹å‡»è¡¨å¤´ç©å®¶åå­—ï¼Œå¿«é€Ÿè®°åˆ† */
            headerPlayerClick(playerIdx) {
                const sessionIdx = State.roomData.sessions.findIndex(s => s.id === State.roomData.currentSessionId);
                if (sessionIdx >= 0) this.openAddSingleScoreModal(sessionIdx, playerIdx);
            },

            /** åˆ·æ–°æˆ¿é—´æ•°æ® */
            refreshRoom() {
                if (State.roomId) this.enterRoom(State.roomId);
            },

            /** æäº¤æ–°æˆ¿é—´è®¾ç½® */
            submitSetup(namesStr) {
                const names = Utils.parseInput(namesStr);
                if (names.length !== 4) return alert('è¯·è¾“å…¥æ­£å¥½4ä¸ªé“ä»”çš„åå­—');
                Service.createRoom(State.roomId, names);
            },

            // ==================== åœºæ¬¡ç®¡ç† ====================

            /** å¼€å¯æ–°åœºæ¬¡ */
            startNewSession(skipConfirm = false) {
                const doStart = () => {
                    const sessions = State.roomData.sessions || [];
                    const newId = sessions.length + 1;
                    sessions.push({ id: newId, rounds: [] });
                    Service.roomRef(State.roomId).update({ sessions, currentSessionId: newId });
                    View.closeModal();
                };

                if (skipConfirm) doStart();
                else View.showModal({ title: 'ç¡®è®¤å¼€å§‹æ–°åœºæ¬¡ï¼Ÿ', body: 'å¼€å§‹åå°†æ— æ³•ä¿®æ”¹ä¹‹å‰çš„åœºæ¬¡æ•°æ®ã€‚', onConfirm: doStart });
            },

            /** åˆ‡æ¢åœºæ¬¡å±•å¼€/æ”¶èµ· */
            toggleSession(id) {
                State.expandedSessions.has(id) ? State.expandedSessions.delete(id) : State.expandedSessions.add(id);
                View.render();
            },

            // ==================== è®°åˆ†ç›¸å…³ ====================

            /** æ‰“å¼€ä¿®æ”¹æ¯åˆ†é‡‘é¢å¼¹çª— */
            openUnitScoreModal() {
                View.showInputModal('ä¿®æ”¹æ¯åˆ†é‡‘é¢', 'è¯·è¾“å…¥æ¯åˆ†å¤šå°‘é’±ï¼š', State.roomData.unitScore, () => {
                    const val = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(val) || val <= 0) return alert('è¯·è¾“å…¥æ­£æ•°');
                    Service.roomRef(State.roomId).update({ unitScore: parseFloat(val.toFixed(1)) });
                    View.closeModal();
                }, 'decimal');
            },

            /**
             * æ‰“å¼€è®°åˆ†å¼¹çª—ï¼ˆä¸€æ¬¡è¾“å…¥4äººåˆ†æ•°ï¼‰
             * @param {number} sessionIdx - åœºæ¬¡ç´¢å¼•
             * @param {number|null} roundIdx - å±€ç´¢å¼•ï¼ˆnullè¡¨ç¤ºæ–°å¢ï¼‰
             */
            openScoreModal(sessionIdx, roundIdx = null) {
                const isEdit = roundIdx !== null;
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                const players = State.roomData.players;

                // æ£€æŸ¥ä¸Šä¸€å±€æ˜¯å¦æœªå®Œæˆï¼ˆæ–°å¢æ—¶ï¼‰
                if (!isEdit && currentRounds.length > 0 && Logic.isRoundPartial(currentRounds[currentRounds.length - 1])) {
                    View.showModal({ title: 'æç¤º', body: 'è¯·ç­‰å¾…å…¶ä»–äººè®°å®Œåˆ†', cancelText: 'è¿”å›', confirmText: null, onConfirm: () => View.closeModal() });
                    return;
                }

                const defaultScores = isEdit ? currentRounds[roundIdx].scores : [null, null, null, null];
                const bodyHtml = players.map((name, i) => `
                    <div class="flex items-center mb-3">
                        <label class="w-20 font-bold text-gray-700 text-base shrink-0">${name}</label>
                        <input type="number" id="scoreInput${i}" value="${defaultScores[i] ?? ''}"
                               inputmode="decimal" ${i === 0 ? 'autofocus' : ''}
                               class="flex-1 border p-3 rounded outline-none focus:border-blue-500 text-center text-lg"
                               placeholder="åˆ†æ•°">
                    </div>
                `).join('');

                View.showModal({
                    title: isEdit ? 'ä¿®æ”¹åˆ†æ•°' : 'æ·»åŠ è®°åˆ†',
                    body: bodyHtml,
                    onConfirm: () => {
                        const scores = players.map((_, i) => {
                            const val = document.getElementById(`scoreInput${i}`).value;
                            return val === '' ? NaN : parseFloat(val);
                        });
                        if (scores.some(isNaN)) return alert('è¯·è¾“å…¥4ä¸ªæœ‰æ•ˆæ•°å­—');

                        if (isEdit) {
                            currentRounds[roundIdx].scores = scores;
                            currentRounds[roundIdx].timestamp = Date.now();
                        } else {
                            currentRounds.push({ roundIndex: currentRounds.length, scores, timestamp: Date.now() });
                        }

                        this.saveScores(sessionIdx, currentRounds);
                        View.closeModal();
                        setTimeout(() => this.checkGameOver(sessionIdx), 500);
                    }
                });
            },

            /** æ‰“å¼€å•äººè®°åˆ†å¼¹çª—ï¼ˆæœ¬å±€å¿«é€Ÿè®°åˆ†ï¼‰ */
            openAddSingleScoreModal(sessionIdx, playerIdx) {
                const playerName = State.roomData.players[playerIdx];
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                const lastRound = currentRounds[currentRounds.length - 1];

                // å·²æœ‰åˆ†æ•°æ—¶ä¸å…è®¸é‡å¤è¾“å…¥
                if (lastRound?.scores?.[playerIdx] !== null && lastRound?.scores?.[playerIdx] !== undefined) {
                    if (Logic.isRoundPartial(lastRound)) {
                        View.showModal({ title: 'æç¤º', body: 'è¯¥ç©å®¶å·²è®°åˆ†ï¼Œè¯·ç­‰å¾…å…¶ä»–ç©å®¶', cancelText: 'è¿”å›', confirmText: null, onConfirm: () => View.closeModal() });
                        return;
                    }
                }

                View.showInputModal(`æ·»åŠ  ${playerName} çš„åˆ†æ•°`, 'è¯·è¾“å…¥åˆ†æ•°ï¼š', '', () => {
                    const val = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(val)) return alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—');

                    let lastRound = currentRounds[currentRounds.length - 1];
                    if (Logic.isRoundPartial(lastRound)) {
                        if (!lastRound.scores) lastRound.scores = [null, null, null, null];
                        lastRound.scores[playerIdx] = val;
                        lastRound.timestamp = Date.now();
                    } else {
                        const newScores = [null, null, null, null];
                        newScores[playerIdx] = val;
                        currentRounds.push({ roundIndex: currentRounds.length, scores: newScores, timestamp: Date.now() });
                    }

                    this.saveScores(sessionIdx, currentRounds);
                    View.closeModal();
                    setTimeout(() => this.checkGameOver(sessionIdx), 500);
                }, 'decimal');
            },

            /** æ‰“å¼€ä¿®æ”¹å•äººåˆ†æ•°å¼¹çª—ï¼ˆå†å²è®°å½•ä¿®æ”¹ï¼‰ */
            openSingleScoreModal(sessionIdx, roundIdx, playerIdx) {
                const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                const currentScore = currentRounds[roundIdx].scores[playerIdx];
                const playerName = State.roomData.players[playerIdx];

                // å·²æœ‰åˆ†æ•°æ—¶éœ€è¦ç¡®è®¤
                if (currentScore !== null && currentScore !== undefined) {
                    View.showModal({
                        title: 'æç¤º',
                        body: 'è¿™ä¸æ˜¯æ–°å¢åˆ†æ•°ï¼Œç¡®å®šä¿®æ”¹å—ï¼Ÿ',
                        confirmText: 'ç¡®å®šä¿®æ”¹',
                        cancelText: 'è¿”å›',
                        onConfirm: () => {
                            View.closeModal();
                            setTimeout(() => this.showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore), 200);
                        }
                    });
                    return;
                }
                this.showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore);
            },

            /** æ˜¾ç¤ºå•äººåˆ†æ•°è¾“å…¥å¼¹çª— */
            showSingleScoreInputModal(sessionIdx, roundIdx, playerIdx, playerName, currentScore) {
                View.showInputModal(`ä¿®æ”¹ ${playerName} çš„åˆ†æ•°`, currentScore === undefined ? 'è¯·è¾“å…¥åˆ†æ•°ï¼š' : 'è¯·è¾“å…¥æ–°çš„åˆ†æ•°ï¼š', currentScore || '', () => {
                    const val = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(val)) return alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—');

                    const currentRounds = State.roomData.sessions[sessionIdx].rounds || [];
                    currentRounds[roundIdx].scores[playerIdx] = val;
                    currentRounds[roundIdx].timestamp = Date.now();

                    this.saveScores(sessionIdx, currentRounds);
                    View.closeModal();
                    setTimeout(() => this.checkGameOver(sessionIdx), 500);
                }, 'decimal');
            },

            /** ä¿å­˜åˆ†æ•°åˆ°Firebase */
            saveScores(sessionIdx, rounds) {
                Service.roomRef(State.roomId).child(`sessions/${sessionIdx}/rounds`).set(rounds);
                Service.roomRef(State.roomId).child('lastScoreTime').set(Date.now());
            },

            /** æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ */
            checkGameOver(sessionIdx) {
                if (Logic.isGameOver(State.roomData.sessions[sessionIdx])) {
                    View.showGameOverModal(() => View.closeModal(), () => this.startNewSession(true));
                }
            },

            // ==================== èœå•åŠŸèƒ½ ====================

            async menuViewRooms() {
                this.toggleMenu();
                View.showLoading(true);
                const rooms = await Service.getAllRooms();
                View.showLoading(false);
                View.showRoomListModal(rooms, false);
            },

            menuCleanRoom() {
                this.toggleMenu();
                View.showInputModal('æ¸…ç†æˆ¿é—´', 'è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š', '', (pwd) => {
                    if (pwd !== 'clean') {
                        View.showMessageModal('é”™è¯¯', 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', () => View.closeModal());
                        return;
                    }
                    View.closeModal();
                    setTimeout(async () => {
                        View.showLoading(true);
                        const rooms = await Service.getAllRooms();
                        View.showLoading(false);
                        View.showRoomListModal(rooms, true);
                    }, 200);
                });
            },

            confirmDeleteRoom(roomId) {
                View.showDeleteRoomModal(roomId, () => {
                    Service.deleteRoom(roomId)
                        .then(() => View.showMessageModal('åˆ é™¤æˆåŠŸ', `æˆ¿é—´ ${roomId} å·²åˆ é™¤`, () => {
                            View.closeModal();
                            setTimeout(async () => {
                                View.showLoading(true);
                                const rooms = await Service.getAllRooms();
                                View.showLoading(false);
                                View.showRoomListModal(rooms, true);
                            }, 200);
                        }))
                        .catch(e => View.showMessageModal('åˆ é™¤å¤±è´¥', 'åˆ é™¤å¤±è´¥ï¼š' + e.message, () => View.closeModal()));
                });
            },

            menuUsage() {
                this.toggleMenu();
                View.showUsageModal();
            },

            menuAbout() {
                this.toggleMenu();
                View.showAboutModal();
            },

            closeModal() {
                View.closeModal();
            }
        };

        // å°†AppæŒ‚è½½åˆ°windowï¼Œä½¿onclickå±æ€§å¯ä»¥è®¿é—®
        window.App = App;

        // å¯åŠ¨åº”ç”¨
        App.init();
    </script>
</body>

</html>
